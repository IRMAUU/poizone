<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>poiz.one paint</title>
  <link rel="shortcut icon" href="favicon.png">
  <meta name="theme-color" content="#070707">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Eagle+Lake&family=Jacquard+24&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    html,body{margin:0;padding:5;height:100%;background:#070707;font-family:'Roboto Mono',monospace;font-weight:700;user-select:none;color:#39ff14;font-size:14px;}
    a{font-family:'Roboto Mono',monospace;font-weight:700;user-select:none;color:#39ff14;font-size:8px;text-decoration:underline;}
    .footer{position:fixed;left:0;bottom:50;width:100%;background:#000;text-align:center;}
    input,textarea,label,button,.menu-title,.tool-option{color:#39ff14;font-family:'Roboto Mono',monospace;font-weight:700;font-size:14px;}
    input,textarea{user-select:auto;}
    input[type="number"],input[type="text"]{background:#000;color:#39ff14;border:1px solid #39ff14;padding:2px 4px;}
    input[type="number"].no-arrows::-webkit-inner-spin-button,input[type="number"].no-arrows::-webkit-outer-spin-button{appearance:none;margin:0;}
    input[type="number"].no-arrows{-moz-appearance:textfield;}
    button{background:#000;color:#39ff14;border:1px solid #39ff14;padding:4px 8px;cursor:pointer;font-family:'Roboto Mono',monospace;font-weight:700;}
    #app-container{width:80vw;height:80vh;margin:auto;position:relative;top:1vh;background:#fff;display:flex;justify-content:center;align-items:center;}
    canvas#paint-canvas{width:100%;height:100%;background:#fff;image-rendering:pixelated;border:1px solid #000;cursor:crosshair;}
    #tool-panel{position:absolute;top:10px;left:10px;background:#222;color:#39ff14;padding:8px;border:1px solid #555;z-index:20;user-select:none;border-radius:6px;}
    .menu-title{cursor:move;padding:4px;text-transform:lowercase;}
    .menu-title#undo-btn{cursor:pointer;color:#39ff14;}
    .dropdown{margin-top:5px;background:#444;padding:5px;border:1px solid #666;border-radius:6px;}
    .tool-option{cursor:pointer;padding:3px;color:#ccc;text-transform:lowercase;background:none;transition:background 0.15s;}
    .tool-option.selected{background-color:#666!important;color:#39ff14!important;}
    .tool-settings{margin-left:15px;margin-top:5px;}
    .hidden{display:none;}
    .import-label{display:block;margin-top:5px;cursor:pointer;}
    input[type="file"]{display:none;}
    .export-settings{margin-top:5px;}
    @media (max-width:900px){
      #tool-panel{transform:scale(0.75);transform-origin:top left;}
      img[src="ppt.png"]{min-width:150px;width:20%;}
    }
    .tool-option.clear-tool{background-color:#ff0000;color:#fff;}
    .tool-option.clear-tool.selected{background-color:#ff4d4d!important;color:#fff!important;}
    .clear-settings{margin-left:15px;margin-top:5px;display:flex;gap:10px;}
    .clear-settings button{background:#333;color:#ff0000;border:1px solid #ff0000;padding:4px 8px;cursor:pointer;font-family:'Roboto Mono',monospace;font-weight:700;}
    .pattern-btn.pattern-selected,.symbol-btn.symbol-selected,.calligraphy-btn.calligraphy-selected{border:2px solid #39ff14!important;}
    .pattern-btn:not(.pattern-selected),.symbol-btn:not(.symbol-selected),.calligraphy-btn:not(.calligraphy-selected){border:2px solid #222!important;}
    .pattern-btn,.symbol-btn,.calligraphy-btn{
      background:#fff;
      border-radius:4px;
      padding:0;
      margin:0;
      min-width:28px;
      min-height:28px;
      width:32px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:24px;
      cursor:pointer;
      font-family: 'Roboto Mono', 'DejaVu Sans Mono', 'Liberation Mono', 'Consolas', 'Courier', 'monospace', 'Arial', 'sans-serif';
      font-variant-ligatures: none;
      font-feature-settings: "liga" 0, "calt" 0;
      unicode-bidi: isolate;
      color: #000 !important;
    }
    .force-plain-text {
      font-family: 'Roboto Mono', 'DejaVu Sans Mono', 'Liberation Mono', 'Consolas', 'Courier', 'monospace', 'Arial', 'sans-serif' !important;
      font-variant-ligatures: none !important;
      font-feature-settings: "liga" 0, "calt" 0 !important;
      unicode-bidi: isolate;
    }
    .font-dropdown{position:relative;display:inline-block;min-width:100px;cursor:pointer;background:#222;border:1px solid #39ff14;color:#39ff14;border-radius:4px;font-size:14px;margin-bottom:6px;margin-right:2px;}
    .font-dropdown-selected{padding:3px 8px;background:#222;border-radius:4px;min-width:120px;display:flex;align-items:center;user-select:none;}
    .font-dropdown-list{display:none;position:absolute;background:#222;border:1px solid #222;z-index:9;left:0;right:0;max-height:200px;overflow-y:auto;margin-top:2px;border-radius:4px;}
    .font-dropdown.open .font-dropdown-list{display:block;}
    .font-dropdown-option{padding:4px 8px;cursor:pointer;color:#39ff14;background:#222;border-bottom:1px solid #333;user-select:none;}
    .font-dropdown-option:last-child{border-bottom:none;}
    .font-dropdown-option:hover,.font-dropdown-option.selected{background:#39ff14;color:#222;}
    .font-dropdown-arrow{margin-left:auto;margin-right:2px;font-size:12px;color:#39ff14;}
    #import-preview-img {
      position:absolute;
      pointer-events:auto;
      z-index:5;
      user-select:none;
      transition:box-shadow 0.2s;
      box-shadow: 0 0 0 2px #f00;
      border: 2px solid #f00;
      opacity: 0.5;
      touch-action: none;
      background: transparent;
      will-change: transform;
      box-sizing: border-box;
    }
    #import-preview-img.stamping {
      pointer-events:none;
      opacity:1;
      border:none;
      box-shadow:none;
      transition: none;
    }
    .flip-btns {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top:7px;
      margin-bottom:7px;
    }
    .flip-btns button {
      width: 100%;
      padding: 5px 0;
      margin: 0;
      background: #111;
      color: #39ff14;
      border: 1px solid #39ff14;
      border-radius: 3px;
      font-size: 13px;
      cursor:pointer;
    }
    .flip-btns button:active {
      background:#333;
    }
    #import-cancel-btn, #import-stamp-btn {
      margin-right: 10px;
      margin-top: 7px;
      margin-bottom: 7px;
    }
    @media (max-width:900px){
      #import-preview-img{max-width:90vw;max-height:60vh;}
    }
    .rotation-control {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
      margin-bottom: 2px;
    }
    .rotation-control input[type="number"].no-arrows {
      width: 45px;
      background: #000;
      border: 1px solid #39ff14;
      color: #39ff14;
      font-size: 13px;
      text-align: right;
      padding:2px 4px;
      margin-left: 2px;
    }
    #text-preview-overlay {
      position: absolute;
      z-index: 6;
      pointer-events: auto;
      user-select: none;
      cursor: grab;
      min-width: 10px;
      min-height: 10px;
      will-change: transform;
      display: none;
      border: 2px solid #f00 !important;
      box-shadow: 0 0 0 2px #f00;
      background: transparent;
      opacity: 0.5;
      padding: 0;
      margin: 0;
      box-sizing: border-box;
      transform-origin: center center;
    }
    #text-preview-content {
      font-weight: 700;
      display: inline-block;
      background: transparent;
      color: #000;
      pointer-events: none;
      user-select: none;
      padding: 0;
      margin: 0;
      min-width: 10px;
      min-height: 10px;
      font-family: inherit;
      font-size: inherit;
      white-space: pre;
    }
    #text-toolbox-controls {
      display: flex;
      flex-direction: row;
      gap: 8px;
      margin-top: 7px;
      margin-bottom: 7px;
    }
    #text-toolbox-controls button {
      font-size:13px;
      background:#111;
      color:#39ff14;
      border:1px solid #39ff14;
      border-radius:3px;
      padding:3px 10px;
      cursor:pointer;
    }
    #text-toolbox-controls button:active {
      background:#333;
    }
    .text-rotation-wrapper,.text-size-wrapper {
      margin-top: 7px;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .text-rotation-wrapper label,.text-size-wrapper label {
      margin-right: 4px;
    }
    .text-rotation-wrapper input[type="number"].no-arrows,
    .text-size-wrapper input[type="number"].no-arrows {
      width: 45px;
      background: #000;
      border: 1px solid #39ff14;
      color: #39ff14;
      font-size: 13px;
      text-align: right;
      padding:2px 4px;
    }
  </style>
</head>
<body>
<center><img src="ppt.png" width="13%"></center>
<div id="app-container">
<canvas id="paint-canvas"></canvas>
<div id="tool-panel">
<!-- ...your tool panel HTML remains unchanged... -->
<div class="menu-title" id="tool-panel-header" data-menu="tools">-tools</div>
<!-- ...rest of your panel code... -->
</div>
</div>
<script>
const canvas = document.getElementById('paint-canvas'), ctx = canvas.getContext('2d');
canvas.width = canvas.offsetWidth;canvas.height = canvas.offsetHeight;ctx.imageSmoothingEnabled = false;
let undoStack=[],MAX_UNDO=20;
function saveState(){if(undoStack.length>=MAX_UNDO)undoStack.shift();try{undoStack.push(ctx.getImageData(0,0,canvas.width,canvas.height));}catch(e){}}
function undo(){if(undoStack.length>0){let imgData=undoStack.pop();ctx.putImageData(imgData,0,0);}}
function resizeCanvas(){const r=canvas.getBoundingClientRect(),img=ctx.getImageData(0,0,canvas.width,canvas.height);canvas.width=r.width;canvas.height=r.height;ctx.imageSmoothingEnabled=false;ctx.putImageData(img,0,0);}
resizeCanvas();window.addEventListener('resize',resizeCanvas);
let drawing=false,currentTool='marker',markerSize=3,eraserSize=3,color='#000000',bucketColor='#000000',flow=2500,lastPos=null,spraySize=3,spraySpread=16,sprayFlow=50,sprayColor='#000000',calligraphySize=20,calligraphyFlow=2500,calligraphyType=0,symbolSize=35,symbolType=0,textFont="Arial",textSize=32,textColor="#000000",textString="your text",calligraphyColor="#000000",symbolColor="#000000";
const calligraphyBrushes=[ "♥\uFE0E", "⎸\uFE0E", "✦\uFE0E", "◢\uFE0E", "◣\uFE0E", "♦\uFE0E" ];
let calligraphyBrushType=0;
const symbolChars=[ "★\uFE0E", "☠\uFE0E", "☣\uFE0E", "✠\uFE0E", "☭\uFE0E", "☮\uFE0E" ];
let symbolCharType=0;
document.querySelectorAll('.calligraphy-btn').forEach((btn,i)=>{btn.onclick=()=>{document.querySelectorAll('.calligraphy-btn').forEach(b=>b.classList.remove('calligraphy-selected'));btn.classList.add('calligraphy-selected');calligraphyBrushType=i;}});
document.querySelectorAll('.symbol-btn').forEach((btn,i)=>{btn.onclick=()=>{document.querySelectorAll('.symbol-btn').forEach(b=>b.classList.remove('symbol-selected'));btn.classList.add('symbol-selected');symbolCharType=i;}});
document.getElementById('marker-size').oninput=e=>{markerSize=+e.target.value;};
document.getElementById('marker-flow').oninput=e=>{flow=+e.target.value;};
document.getElementById('color-picker').oninput=e=>color=e.target.value;
document.getElementById('calligraphy-size').oninput=e=>{calligraphySize=+e.target.value;};
document.getElementById('calligraphy-flow').oninput=e=>{calligraphyFlow=+e.target.value;};
document.getElementById('calligraphy-color').oninput=e=>{calligraphyColor=e.target.value;};
document.getElementById('symbol-size').oninput=e=>symbolSize=+e.target.value;
document.getElementById('symbol-color').oninput=e=>{symbolColor=e.target.value;};
const fontDropdown=document.getElementById("font-dropdown"),fontDropdownList=document.getElementById("font-dropdown-list"),fontDropdownSelected=document.getElementById("font-dropdown-selected"),fontDropdownSelectedName=document.getElementById("font-dropdown-selected-name");
Array.from(fontDropdownList.children).forEach(opt=>{opt.onclick=function(){Array.from(fontDropdownList.children).forEach(o=>o.classList.remove("selected"));this.classList.add("selected");textFont = this.getAttribute("data-font");fontDropdownSelectedName.textContent = this.textContent;fontDropdownSelectedName.style.fontFamily = textFont;fontDropdown.classList.remove("open");if(textPreviewActive) updateTextPreviewContent(textString, textFont, textSize, textColor);};});
fontDropdownSelected.onclick=function(e){fontDropdown.classList.toggle("open");};fontDropdown.onblur=function(){fontDropdown.classList.remove("open");};
const textSizeRange=document.getElementById('text-size-range'),textSizeInput=document.getElementById('text-size');
function setTextSize(v){v=Math.max(8,Math.min(150,Number(v)||32));textSize=v;textSizeRange.value=v;textSizeInput.value=v;if(textPreviewActive)updateTextPreviewContent(textString,textFont,textSize,textColor);}
textSizeRange.addEventListener('input',function(){setTextSize(this.value);});
textSizeInput.addEventListener('input',function(){setTextSize(this.value);});
document.getElementById('text-color').oninput=e=>{textColor=e.target.value;if(textPreviewActive) updateTextPreviewContent(textString, textFont, textSize, textColor);}
document.getElementById('text-string').oninput=e=>{textString=e.target.value;if(textPreviewActive) updateTextPreviewContent(textString, textFont, textSize, textColor);}
document.getElementById('spray-size').oninput=e=>spraySize=+e.target.value;document.getElementById('spray-spread').oninput=e=>spraySpread=+e.target.value;document.getElementById('spray-flow').oninput=e=>sprayFlow=+e.target.value;document.getElementById('spray-color').oninput=e=>sprayColor=e.target.value;
document.getElementById('bucket-color').oninput=e=>bucketColor=e.target.value;
document.getElementById('eraser-size').oninput=e=>eraserSize=+e.target.value;
function drawCalligraphy(x,y){ctx.save();ctx.font = `${calligraphySize}px 'Roboto Mono', 'DejaVu Sans Mono', 'Liberation Mono', 'Consolas', 'Courier', 'monospace', 'Arial', 'sans-serif'`;ctx.textAlign = "center";ctx.textBaseline = "middle";ctx.fillStyle = calligraphyColor;ctx.fillText(calligraphyBrushes[calligraphyBrushType], x, y);ctx.restore();}
function drawCalligraphyFlowLine(x0,y0,x1,y1){let dx=Math.abs(x1-x0),dy=Math.abs(y1-y0),sx=x0<x1?1:-1,sy=y0<y1?1:-1,err=dx-dy;while(true){drawCalligraphy(x0,y0);if(x0===x1&&y0===y1)break;let e2=2*err;if(e2>-dy){err-=dy;x0+=sx;}if(e2<dx){err+=dx;y0+=sy;}}}
function drawSymbol(x,y){ctx.save();ctx.font = `${symbolSize}px 'Roboto Mono', 'DejaVu Sans Mono', 'Liberation Mono', 'Consolas', 'Courier', 'monospace', 'Arial', 'sans-serif'`;ctx.textAlign = "center";ctx.textBaseline = "middle";ctx.fillStyle = symbolColor;ctx.fillText(symbolChars[symbolCharType], x, y);ctx.restore();}
function getTextBBox(text,font,size){const off=document.createElement('canvas');const offCtx=off.getContext('2d');offCtx.font=`${size}px ${font}`;const lines=text.split('\n');let width=0;for(let l of lines){const m=offCtx.measureText(l);width=Math.max(width,m.width);}return {width,height:lines.length*size*1.15};}
function showTextPreviewOverlay(text,font,size,color,forceCenter){textPreviewActive=true;textPreviewOverlay.style.display="block";textPreviewOverlay.style.boxSizing="border-box";textPreviewContent.textContent=text.replace(/\n/g,"\n");textPreviewOverlay.style.fontFamily=font;textPreviewOverlay.style.fontSize=size+"px";textPreviewOverlay.style.color=color;textPreviewContent.style.fontFamily=font;textPreviewContent.style.fontSize=size+"px";textPreviewContent.style.color=color;let box=getTextBBox(text,font,size);textPreviewOverlay.style.width=box.width+"px";textPreviewOverlay.style.height=box.height+"px";textPreviewOverlay.style.transformOrigin="center center";if(forceCenter||!textPreviewInit){let container=document.getElementById('app-container');textPreviewPosX=(container.offsetWidth-box.width)/2;textPreviewPosY=(container.offsetHeight-box.height)/2;textPreviewInitX=textPreviewPosX;textPreviewInitY=textPreviewPosY;textPreviewInit=true;}textPreviewOverlay.style.left=textPreviewPosX+"px";textPreviewOverlay.style.top=textPreviewPosY+"px";textToolboxControls.style.display="flex";updateTextPreviewTransform();}
function updateTextPreviewContent(text,font,size,color){textPreviewContent.textContent=text.replace(/\n/g,"\n");textPreviewOverlay.style.fontFamily=font;textPreviewOverlay.style.fontSize=size+"px";textPreviewOverlay.style.color=color;textPreviewContent.style.fontFamily=font;textPreviewContent.style.fontSize=size+"px";textPreviewContent.style.color=color;let box=getTextBBox(text,font,size);textPreviewOverlay.style.width=box.width+"px";textPreviewOverlay.style.height=box.height+"px";textPreviewOverlay.style.left=textPreviewPosX+"px";textPreviewOverlay.style.top=textPreviewPosY+"px";updateTextPreviewTransform();}
function updateTextPreviewTransform(){textPreviewOverlay.style.transform=`rotate(${textRotation}deg)`;}
function hideTextPreviewOverlay(){textPreviewActive=false;textPreviewOverlay.style.display="none";textToolboxControls.style.display="none";textPreviewInit=false;textPreviewPosX=0;textPreviewPosY=0;}
const textPreviewOverlay=document.getElementById('text-preview-overlay');
const textPreviewContent=document.getElementById('text-preview-content');
const textSubmitBtn=document.getElementById('text-submit-btn');
const textCancelBtn=document.getElementById('text-cancel-btn');
const textToolboxControls=document.getElementById('text-toolbox-controls');
const textRotationRange=document.getElementById('text-rotation-range');
const textRotationNumber=document.getElementById('text-rotation-number');
let textPreviewActive=false,textPreviewDragging=false,textPreviewOffsetX=0,textPreviewOffsetY=0,textPreviewPosX=0,textPreviewPosY=0,textPreviewInit=false,textPreviewInitX=0,textPreviewInitY=0,textRotation=0;
textPreviewOverlay.onmousedown=function(e){e.preventDefault();textPreviewDragging=true;textPreviewOverlay.style.cursor='grabbing';let rect=textPreviewOverlay.getBoundingClientRect();textPreviewOffsetX=e.clientX-rect.left;textPreviewOffsetY=e.clientY-rect.top;};
textPreviewOverlay.ontouchstart=function(e){if(e.touches.length!==1)return;e.preventDefault();textPreviewDragging=true;textPreviewOverlay.style.cursor='grabbing';let rect=textPreviewOverlay.getBoundingClientRect();let t=e.touches[0];textPreviewOffsetX=t.clientX-rect.left;textPreviewOffsetY=t.clientY-rect.top;};
document.addEventListener('mousemove',function(e){if(!textPreviewDragging||!textPreviewActive)return;let w=textPreviewOverlay.offsetWidth,h=textPreviewOverlay.offsetHeight;const containerRect=document.getElementById('app-container').getBoundingClientRect();let mouseX=e.clientX-containerRect.left,mouseY=e.clientY-containerRect.top,posX=mouseX-textPreviewOffsetX,posY=mouseY-textPreviewOffsetY;textPreviewPosX=posX;textPreviewPosY=posY;textPreviewOverlay.style.left=textPreviewPosX+"px";textPreviewOverlay.style.top=textPreviewPosY+"px";});
document.addEventListener('mouseup',function(){textPreviewDragging=false;textPreviewOverlay.style.cursor='grab';});
document.addEventListener('touchmove',function(e){if(!textPreviewDragging||!textPreviewActive)return;let w=textPreviewOverlay.offsetWidth,h=textPreviewOverlay.offsetHeight;const containerRect=document.getElementById('app-container').getBoundingClientRect();let t=e.touches[0];let touchX=t.clientX-containerRect.left,touchY=t.clientY-containerRect.top,posX=touchX-textPreviewOffsetX,posY=touchY-textPreviewOffsetY;textPreviewPosX=posX;textPreviewPosY=posY;textPreviewOverlay.style.left=textPreviewPosX+"px";textPreviewOverlay.style.top=textPreviewPosY+"px";if(e.cancelable)e.preventDefault();},{passive:false});
document.addEventListener('touchend',function(){textPreviewDragging=false;textPreviewOverlay.style.cursor='grab';});
function setTextRotation(val){let v=Math.max(-180,Math.min(180,Number(val)||0));textRotation=v;textRotationRange.value=v;textRotationNumber.value=v;updateTextPreviewTransform();}
textRotationRange.addEventListener('input',function(){setTextRotation(this.value);});
textRotationNumber.addEventListener('input',function(){setTextRotation(this.value);});
textSubmitBtn.onclick=function(){
  if(!textPreviewActive)return;
  saveState();
  // PATCHED: Use the true center of the DOM text (text-preview-content) for pixel-perfect alignment!
  let contentElem = document.getElementById('text-preview-content');
  let contentRect = contentElem.getBoundingClientRect();
  let canvasRect = canvas.getBoundingClientRect();
  let centerX = contentRect.left + contentRect.width/2;
  let centerY = contentRect.top + contentRect.height/2;
  let px = (centerX - canvasRect.left) * (canvas.width / canvasRect.width);
  let py = (centerY - canvasRect.top) * (canvas.height / canvasRect.height);
  ctx.save();
  ctx.translate(px,py);
  ctx.rotate(textRotation*Math.PI/180);
  ctx.font = `${textSize}px ${textFont}`;
  ctx.fillStyle = textColor;
  ctx.textBaseline = "middle";
  ctx.textAlign = "center";
  let lines=textString.split('\n');
  let blockHeight = lines.length * textSize * 1.15;
  let offsetY = -blockHeight/2 + textSize*1.15/2;
  for(let i=0;i<lines.length;i++){
    ctx.fillText(lines[i], 0, offsetY + i*textSize*1.15);
  }
  ctx.restore();
  showTextPreviewOverlay(textString,textFont,textSize,textColor,false);
  textPreviewPosX=textPreviewInitX;textPreviewPosY=textPreviewInitY;
  textPreviewOverlay.style.left=textPreviewPosX+"px";
  textPreviewOverlay.style.top=textPreviewPosY+"px";
};
textCancelBtn.onclick=hideTextPreviewOverlay;
document.getElementById('text-string').oninput=e=>{textString=e.target.value;if(textPreviewActive)updateTextPreviewContent(textString,textFont,textSize,textColor);};
Array.from(document.getElementsByClassName("font-dropdown-option")).forEach(opt=>{opt.onclick=function(){Array.from(fontDropdownList.children).forEach(o=>o.classList.remove("selected"));this.classList.add("selected");textFont=this.getAttribute("data-font");fontDropdownSelectedName.textContent=this.textContent;fontDropdownSelectedName.style.fontFamily=textFont;fontDropdown.classList.remove("open");if(textPreviewActive)updateTextPreviewContent(textString,textFont,textSize,textColor);};});

// ---- Restored marker/spray/eraser implementation ----
function drawAt(x, y) {
  if (currentTool === "eraser") {
    ctx.save();
    ctx.beginPath();
    ctx.arc(x, y, eraserSize / 2, 0, 2 * Math.PI);
    ctx.fillStyle = "#fff";
    ctx.globalAlpha = 1;
    ctx.fill();
    ctx.restore();
  } else {
    ctx.save();
    ctx.beginPath();
    ctx.arc(x, y, markerSize / 2, 0, 2 * Math.PI);
    ctx.fillStyle = color;
    ctx.globalAlpha = 1;
    ctx.fill();
    ctx.restore();
  }
}

function drawLine(x0, y0, x1, y1) {
  ctx.save();
  ctx.strokeStyle = currentTool === "eraser" ? "#fff" : color;
  ctx.lineWidth = currentTool === "eraser" ? eraserSize : markerSize;
  ctx.lineCap = "round";
  ctx.globalAlpha = 1;
  ctx.beginPath();
  ctx.moveTo(x0, y0);
  ctx.lineTo(x1, y1);
  ctx.stroke();
  ctx.restore();
}

function sprayAt(x, y) {
  ctx.save();
  ctx.fillStyle = sprayColor;
  ctx.globalAlpha = 1;
  for (let i = 0; i < sprayFlow; i++) {
    const angle = Math.random() * 2 * Math.PI;
    const radius = Math.random() * spraySpread;
    ctx.beginPath();
    ctx.arc(
      x + Math.cos(angle) * radius,
      y + Math.sin(angle) * radius,
      spraySize / 2,
      0,
      2 * Math.PI
    );
    ctx.fill();
  }
  ctx.restore();
}
// ---- End restore ----

// Mouse/touch event handlers for all tools including marker/spray/eraser
canvas.addEventListener('mousedown',e=>{
  const r=canvas.getBoundingClientRect(),
        x=Math.floor((e.clientX-r.left)*canvas.width/r.width),
        y=Math.floor((e.clientY-r.top)*canvas.height/r.height);
  if(currentTool==='bucket'){
    saveState();
    floodFill(x,y,bucketColor);
  }else{
    saveState();
    if(currentTool==='calligraphy'){
      drawing=true;lastPos={x,y};drawCalligraphy(x,y);
    }else if(currentTool==='symbol'){
      drawSymbol(x,y);
    }else if(currentTool==='text'){
      // do nothing
    }else if(currentTool==='spray'){
      drawing=true;lastPos={x,y};sprayAt(x,y);
    }else if(currentTool==='eraser' || currentTool==='marker'){
      drawing=true;lastPos={x,y};drawAt(x,y);
    }
  }
});
canvas.addEventListener('mousemove',e=>{
  if(!drawing||currentTool==='bucket'||currentTool==='symbol'||currentTool==='text')return;
  const r=canvas.getBoundingClientRect(),
        x=Math.floor((e.clientX-r.left)*canvas.width/r.width),
        y=Math.floor((e.clientY-r.top)*canvas.height/r.height);
  if(currentTool==='calligraphy'){
    if(lastPos){
      if(calligraphyFlow>=1000){
        drawCalligraphyFlowLine(lastPos.x,lastPos.y,x,y);
      }else{
        let dist=Math.hypot(x-lastPos.x,y-lastPos.y);
        let step=Math.max(1,Math.floor(1000/calligraphyFlow));
        if(dist>step){
          let steps=Math.floor(dist/step);
          for(let i=1;i<=steps;i++){
            let nx=Math.round(lastPos.x+(x-lastPos.x)*i/steps),
                ny=Math.round(lastPos.y+(y-lastPos.y)*i/steps);
            drawCalligraphy(nx,ny);
          }
        }else{
          drawCalligraphy(x,y);
        }
      }
    }else{
      drawCalligraphy(x,y);
    }
  }else if(currentTool==='spray'){
    sprayAt(x,y);
  }else if(currentTool==='eraser' || currentTool==='marker'){
    if(flow>=1000&&lastPos){
      drawLine(lastPos.x,lastPos.y,x,y);
    }else{
      drawAt(x,y);
    }
  }
  lastPos={x,y};
});
canvas.addEventListener('mouseup',()=>{drawing=false;});
function getCanvasCoordsTouch(e){
  const r=canvas.getBoundingClientRect(),t=e.touches[0];
  return{
    x:Math.floor((t.clientX-r.left)*canvas.width/r.width),
    y:Math.floor((t.clientY-r.top)*canvas.height/r.height)
  };
}
canvas.addEventListener('touchstart',e=>{
  e.preventDefault();
  const{x,y}=getCanvasCoordsTouch(e);
  if(currentTool==='bucket'){
    saveState();
    floodFill(x,y,bucketColor);
  }else{
    saveState();
    if(currentTool==='calligraphy'){
      drawing=true;lastPos={x,y};drawCalligraphy(x,y);
    }else if(currentTool==='symbol'){
      drawSymbol(x,y);
    }else if(currentTool==='text'){
      // do nothing
    }else if(currentTool==='spray'){
      drawing=true;lastPos={x,y};sprayAt(x,y);
    }else if(currentTool==='eraser' || currentTool==='marker'){
      drawing=true;lastPos={x,y};drawAt(x,y);
    }
  }
});
canvas.addEventListener('touchmove',e=>{
  e.preventDefault();
  if(!drawing||currentTool==='bucket'||currentTool==='symbol'||currentTool==='text')return;
  const{x,y}=getCanvasCoordsTouch(e);
  if(currentTool==='calligraphy'){
    if(lastPos){
      if(calligraphyFlow>=1000){
        drawCalligraphyFlowLine(lastPos.x,lastPos.y,x,y);
      }else{
        let dist=Math.hypot(x-lastPos.x,y-lastPos.y);
        let step=Math.max(1,Math.floor(1000/calligraphyFlow));
        if(dist>step){
          let steps=Math.floor(dist/step);
          for(let i=1;i<=steps;i++){
            let nx=Math.round(lastPos.x+(x-lastPos.x)*i/steps),
                ny=Math.round(lastPos.y+(y-lastPos.y)*i/steps);
            drawCalligraphy(nx,ny);
          }
        }else{
          drawCalligraphy(x,y);
        }
      }
    }else{
      drawCalligraphy(x,y);
    }
  }else if(currentTool==='spray'){
    sprayAt(x,y);
  }else if(currentTool==='eraser' || currentTool==='marker'){
    if(flow>=1000&&lastPos){
      drawLine(lastPos.x,lastPos.y,x,y);
    }else{
      drawAt(x,y);
    }
  }
  lastPos={x,y};
},{passive:false});
canvas.addEventListener('touchend',()=>{drawing=false;});
canvas.addEventListener('mouseout',()=>{drawing=false;});

function floodFill(x,y,fillHex){let imgData;try{imgData=ctx.getImageData(0,0,canvas.width,canvas.height);}catch(e){alert("Bucket fill unavailable: Canvas is tainted (see console). Only use local or CORS-enabled assets.");return;}const targetColor=getPixelColor(x,y,imgData),fillColor=hexToRgb(fillHex).concat(255);if(colorsMatch(targetColor,fillColor))return;const stack=[[x,y]];while(stack.length){const[cx,cy]=stack.pop();if(cx<0||cy<0||cx>=canvas.width||cy>=canvas.height)continue;const currentColor=getPixelColor(cx,cy,imgData);if(!colorsMatch(currentColor,targetColor))continue;const i=(cy*canvas.width+cx)*4;imgData.data.set(fillColor,i);stack.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);}ctx.putImageData(imgData,0,0);}
function hexToRgb(hex){const b=parseInt(hex.slice(1),16);return[(b>>16)&255,(b>>8)&255,b&255];}
function getPixelColor(x,y,imgData){const i=(y*imgData.width+x)*4;return[imgData.data[i],imgData.data[i+1],imgData.data[i+2],imgData.data[i+3]];}
function colorsMatch(a,b){return a.every((v,i)=>v===b[i]);}
// --- import image logic ---
let importImg=null,importImgNaturalWidth=0,importImgNaturalHeight=0,importPreview=null,importDragging=false,importOffsetX=0,importOffsetY=0,importPosX=0,importPosY=0,importScale=0.5,importRotation=0,importOpacity=0.75,importFlipH=1,importFlipV=1;
const importSettingsDiv=document.getElementById('import-settings'),importFileInput=document.getElementById('import-image-file'),importSizeSlider=document.getElementById('import-size'),importSizeValue=document.getElementById('import-size-value'),importOpacitySlider=document.getElementById('import-opacity'),importOpacityValue=document.getElementById('import-opacity-value'),importRotationSlider=document.getElementById('import-rotation'),importRotationNumber=document.getElementById('import-rotation-number'),importFlipHBtn=document.getElementById('import-flip-h'),importFlipVBtn=document.getElementById('import-flip-v'),importStampBtn=document.getElementById('import-stamp-btn'),importCancelBtn=document.getElementById('import-cancel-btn'),importDropdown=document.getElementById('import-dropdown');
function hideImportPreview(){if(importPreview&&importPreview.parentNode){importPreview.parentNode.removeChild(importPreview);importPreview=null;}}
function showImportPreview(){hideImportPreview();if(!importImg)return;importPreview=document.createElement('img');importPreview.id='import-preview-img';importPreview.src=importImg.src;importPreview.draggable=false;importPreview.style.position='absolute';importPreview.style.opacity=importOpacity.toString();importPreview.style.pointerEvents='auto';importPreview.style.cursor='grab';importPreview.style.zIndex=5;importPreview.style.boxSizing='border-box';let container=document.getElementById('app-container');container.appendChild(importPreview);updateImportPreviewTransform();importPreview.onmousedown=function(e){e.preventDefault();importDragging=true;let rect=importPreview.getBoundingClientRect();importOffsetX=e.clientX-rect.left;importOffsetY=e.clientY-rect.top;};document.addEventListener('mousemove',imagePreviewDragMove);document.addEventListener('mouseup',imagePreviewDragEnd);importPreview.ontouchstart=function(e){if(e.touches.length!==1)return;e.preventDefault();importDragging=true;let rect=importPreview.getBoundingClientRect();let t=e.touches[0];importOffsetX=t.clientX-rect.left;importOffsetY=t.clientY-rect.top;};document.addEventListener('touchmove',imagePreviewDragMove,{passive:false});document.addEventListener('touchend',imagePreviewDragEnd);}
function imagePreviewDragMove(e){if(!importDragging||!importPreview)return;let container=document.getElementById('app-container');let clientX,clientY;if(e.touches&&e.touches.length){clientX=e.touches[0].clientX;clientY=e.touches[0].clientY;}else{clientX=e.clientX;clientY=e.clientY;}let posX=clientX-container.getBoundingClientRect().left-importOffsetX;let posY=clientY-container.getBoundingClientRect().top-importOffsetY;importPosX=posX;importPosY=posY;updateImportPreviewTransform();if(e.cancelable)e.preventDefault();}
function imagePreviewDragEnd(e){if(importDragging){importDragging=false;if(importPreview)importPreview.style.cursor='grab';}}
function updateImportPreviewTransform(){if(!importPreview)return;let w=Math.max(1,Math.round(importImgNaturalWidth*importScale)),h=Math.max(1,Math.round(importImgNaturalHeight*importScale));importPreview.style.width=w+'px';importPreview.style.height=h+'px';importPreview.style.left=importPosX+'px';importPreview.style.top=importPosY+'px';let rot=importRotation,scaleX=importFlipH,scaleY=importFlipV;importPreview.style.transform=`rotate(${rot}deg) scale(${scaleX},${scaleY})`;importPreview.style.opacity=importOpacity;}
function stampImageToCanvas(){if(!importImg)return;saveState();let container=document.getElementById('app-container');let w=importPreview.offsetWidth,h=importPreview.offsetHeight;let px=(importPosX)*(canvas.width/container.offsetWidth),py=(importPosY)*(canvas.height/container.offsetHeight);ctx.save();ctx.globalAlpha=importOpacity;ctx.translate(px+w/2,py+h/2);ctx.rotate(importRotation*Math.PI/180);ctx.scale(importFlipH,importFlipV);ctx.drawImage(importImg,-w/2,-h/2,w,h);ctx.restore();hideImportPreview();importImg=null;importSettingsDiv.classList.add('hidden');importFileInput.value='';}
function importResetState(){importImg=null;importImgNaturalWidth=0;importImgNaturalHeight=0;importScale=0.5;importRotation=0;importOpacity=0.75;importFlipH=1;importFlipV=1;let container=document.getElementById('app-container');importPosX=(container.offsetWidth/2)-50;importPosY=(container.offsetHeight/2)-50;hideImportPreview();importSettingsDiv.classList.add('hidden');}
importFileInput.addEventListener('change',function(e){let file=this.files[0];if(!file)return;importResetState();let reader=new FileReader();reader.onload=function(evt){let img=new window.Image();img.onload=function(){importImg=img;importImgNaturalWidth=img.naturalWidth;importImgNaturalHeight=img.naturalHeight;let container=document.getElementById('app-container');importScale=0.5;importSizeSlider.value=50;importSizeValue.textContent=50;importOpacity=parseInt(importOpacitySlider.value,10)/100.0;importRotation=parseInt(importRotationSlider.value,10);importRotationNumber.value=importRotation;importFlipH=1;importFlipV=1;let w=Math.max(1,Math.round(importImgNaturalWidth*importScale)),h=Math.max(1,Math.round(importImgNaturalHeight*importScale));importPosX=(container.offsetWidth-w)/2;importPosY=(container.offsetHeight-h)/2;importOpacityValue.textContent=importOpacitySlider.value;importSettingsDiv.classList.remove('hidden');showImportPreview();};img.src=evt.target.result;};reader.readAsDataURL(file);});
importSizeSlider.addEventListener('input',function(){importScale=parseInt(this.value,10)/100.0;importSizeValue.textContent=this.value;let container=document.getElementById('app-container');let w=Math.max(1,Math.round(importImgNaturalWidth*importScale)),h=Math.max(1,Math.round(importImgNaturalHeight*importScale));importPosX=(container.offsetWidth-w)/2;importPosY=(container.offsetHeight-h)/2;updateImportPreviewTransform();});
importOpacitySlider.addEventListener('input',function(){importOpacity=parseInt(this.value,10)/100.0;importOpacityValue.textContent=this.value;if(importPreview)importPreview.style.opacity=importOpacity;});
function setImportRotation(val){
  let v=Math.max(-180,Math.min(180,Number(val)||0));
  importRotation=v;
  importRotationSlider.value = v;
  importRotationNumber.value = v;
  updateImportPreviewTransform();
}
importRotationSlider.addEventListener('input',function(){setImportRotation(this.value);});
importRotationNumber.addEventListener('input',function(){setImportRotation(this.value);});
importFlipHBtn.addEventListener('click',function(){importFlipH*=-1;updateImportPreviewTransform();});
importFlipVBtn.addEventListener('click',function(){importFlipV*=-1;updateImportPreviewTransform();});
importStampBtn.addEventListener('click',function(){stampImageToCanvas();});
importCancelBtn.addEventListener('click',function(){importResetState();});
document.querySelectorAll('.menu-title').forEach(title=>{title.addEventListener('click',()=>{if(title.id==="undo-btn")return;const menu=title.dataset.menu,dropdown=document.getElementById(`${menu}-dropdown`),isAlreadyOpen=!dropdown.classList.contains('hidden');document.querySelectorAll('.dropdown').forEach(d=>d.classList.add('hidden'));if(!isAlreadyOpen)dropdown.classList.remove('hidden');if(menu!=='import')importResetState();});});
document.getElementById('export-back').addEventListener('click',()=>{document.getElementById('export-dropdown').classList.add('hidden');});
document.getElementById('undo-btn').addEventListener('click',()=>{undo();});
document.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='z')undo();});
document.querySelectorAll('.tool-option').forEach(opt=>{opt.addEventListener('click',()=>{const tool=opt.id.split('-')[0],settings=document.getElementById(`${tool}-settings`);if(currentTool===tool){if(settings)settings.classList.toggle('hidden');return;}currentTool=tool;setToolHighlight(currentTool);if(tool==="text"){showTextPreviewOverlay(textString,textFont,textSize,textColor,true);}else{hideTextPreviewOverlay();}});});
function setToolHighlight(tool){['marker','calligraphy','symbol','text','spray','eraser','bucket','clear'].forEach(t=>{const settings=document.getElementById(`${t}-settings`),option=document.getElementById(`${t}-option`);if(settings)settings.classList.add('hidden');if(option)option.classList.remove('selected');});const settings=document.getElementById(`${tool}-settings`),option=document.getElementById(`${tool}-option`);if(settings)settings.classList.remove('hidden');if(option)option.classList.add('selected');}
document.getElementById('clear-yes').addEventListener('click',()=>{saveState();ctx.clearRect(0,0,canvas.width,canvas.height);document.getElementById('clear-settings').classList.add('hidden');});
document.getElementById('clear-back').addEventListener('click',()=>{document.getElementById('clear-settings').classList.add('hidden');});
document.getElementById('export-btn').addEventListener('click',()=>{const filename=document.getElementById('file-name').value||'pixel-art',transparent=document.getElementById('transparent-bg').checked;if(!transparent){const tempCanvas=document.createElement('canvas');tempCanvas.width=canvas.width;tempCanvas.height=canvas.height;const tempCtx=tempCanvas.getContext('2d');tempCtx.fillStyle="#fff";tempCtx.fillRect(0,0,tempCanvas.width,tempCanvas.height);tempCtx.drawImage(canvas,0,0);const link=document.createElement('a');link.download=filename+'.png';link.href=tempCanvas.toDataURL('image/png');link.click();}else{const link=document.createElement('a');link.download=filename+'.png';link.href=canvas.toDataURL('image/png');link.click();}});
</script>
<div class="footer"><center><a href="https://instagram.com/poiz.0ne">@poiz.0ne</a></center></div>
</body>
</html>
