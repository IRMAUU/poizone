<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>poiz.one paint</title>
  <link rel="shortcut icon" href="favicon.png">
  <meta name="theme-color" content="#070707">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Eagle+Lake&family=Jacquard+24&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    html,body{margin:0;padding:5;height:100%;background:#070707;font-family:'Roboto Mono',monospace;font-weight:700;user-select:none;color:#39ff14;font-size:14px;}
    a{font-family:'Roboto Mono',monospace;font-weight:700;user-select:none;color:#39ff14;font-size:8px;text-decoration:underline;}
    .footer{position:fixed;left:0;bottom:50;width:100%;background:#000;text-align:center;}
    input,textarea,label,button,.menu-title,.tool-option{color:#39ff14;font-family:'Roboto Mono',monospace;font-weight:700;font-size:14px;}
    input,textarea{user-select:auto;}
    input[type="number"],input[type="text"]{background:#000;color:#39ff14;border:1px solid #39ff14;padding:2px 4px;}
    input[type="number"].no-arrows::-webkit-inner-spin-button,input[type="number"].no-arrows::-webkit-outer-spin-button{appearance:none;margin:0;}
    input[type="number"].no-arrows{-moz-appearance:textfield;}
    button{background:#000;color:#39ff14;border:1px solid #39ff14;padding:4px 8px;cursor:pointer;font-family:'Roboto Mono',monospace;font-weight:700;}
    #app-container{width:80vw;height:80vh;margin:auto;position:relative;top:1vh;background:#fff;display:flex;justify-content:center;align-items:center;}
    canvas#paint-canvas{width:100%;height:100%;background:#fff;image-rendering:pixelated;border:1px solid #000;cursor:crosshair;}
    #tool-panel{position:absolute;top:10px;left:10px;background:#222;color:#39ff14;padding:8px;border:1px solid #555;z-index:20;user-select:none;border-radius:6px;}
    .menu-title{cursor:move;padding:4px;text-transform:lowercase;}
    .menu-title#undo-btn{cursor:pointer;color:#39ff14;}
    .dropdown{margin-top:5px;background:#444;padding:5px;border:1px solid #666;border-radius:6px;}
    .tool-option{cursor:pointer;padding:3px;color:#ccc;text-transform:lowercase;background:none;transition:background 0.15s;}
    .tool-option.selected{background-color:#666!important;color:#39ff14!important;}
    .tool-settings{margin-left:15px;margin-top:5px;}
    .hidden{display:none;}
    .import-label{display:block;margin-top:5px;cursor:pointer;}
    input[type="file"]{display:none;}
    .export-settings{margin-top:5px;}
    @media (max-width:900px){
      #tool-panel{transform:scale(0.75);transform-origin:top left;}
      img[src="ppt.png"]{min-width:150px;width:20%;}
    }
    .tool-option.clear-tool{background-color:#ff0000;color:#fff;}
    .tool-option.clear-tool.selected{background-color:#ff4d4d!important;color:#fff!important;}
    .clear-settings{margin-left:15px;margin-top:5px;display:flex;gap:10px;}
    .clear-settings button{background:#333;color:#ff0000;border:1px solid #ff0000;padding:4px 8px;cursor:pointer;font-family:'Roboto Mono',monospace;font-weight:700;}
    .pattern-btn.pattern-selected,.symbol-btn.symbol-selected,.calligraphy-btn.calligraphy-selected{border:2px solid #39ff14!important;}
    .pattern-btn:not(.pattern-selected),.symbol-btn:not(.symbol-selected),.calligraphy-btn:not(.calligraphy-selected){border:2px solid #222!important;}
    .pattern-btn,.symbol-btn,.calligraphy-btn{
      background:#fff;
      border-radius:4px;
      padding:0;
      margin:0;
      min-width:28px;
      min-height:28px;
      width:32px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:24px;
      cursor:pointer;
      font-family: 'Roboto Mono', 'DejaVu Sans Mono', 'Liberation Mono', 'Consolas', 'Courier', 'monospace', 'Arial', 'sans-serif';
      font-variant-ligatures: none;
      font-feature-settings: "liga" 0, "calt" 0;
      unicode-bidi: isolate;
      color: #000 !important;
    }
    .force-plain-text {
      font-family: 'Roboto Mono', 'DejaVu Sans Mono', 'Liberation Mono', 'Consolas', 'Courier', 'monospace', 'Arial', 'sans-serif' !important;
      font-variant-ligatures: none !important;
      font-feature-settings: "liga" 0, "calt" 0 !important;
      unicode-bidi: isolate;
    }
    .font-dropdown{position:relative;display:inline-block;min-width:100px;cursor:pointer;background:#222;border:1px solid #39ff14;color:#39ff14;border-radius:4px;font-size:14px;margin-bottom:6px;margin-right:2px;}
    .font-dropdown-selected{padding:3px 8px;background:#222;border-radius:4px;min-width:120px;display:flex;align-items:center;user-select:none;}
    .font-dropdown-list{display:none;position:absolute;background:#222;border:1px solid #222;z-index:9;left:0;right:0;max-height:200px;overflow-y:auto;margin-top:2px;border-radius:4px;}
    .font-dropdown.open .font-dropdown-list{display:block;}
    .font-dropdown-option{padding:4px 8px;cursor:pointer;color:#39ff14;background:#222;border-bottom:1px solid #333;user-select:none;}
    .font-dropdown-option:last-child{border-bottom:none;}
    .font-dropdown-option:hover,.font-dropdown-option.selected{background:#39ff14;color:#222;}
    .font-dropdown-arrow{margin-left:auto;margin-right:2px;font-size:12px;color:#39ff14;}
    #import-preview-img {
      position:absolute;
      pointer-events:auto;
      z-index:5;
      user-select:none;
      transition:box-shadow 0.2s;
      box-shadow: 0 0 0 2px #f00;
      border: 2px solid #f00;
      opacity: 0.5;
      touch-action: none;
      background: transparent;
      will-change: transform;
      box-sizing: border-box;
    }
    #import-preview-img.stamping {
      pointer-events:none;
      opacity:1;
      border:none;
      box-shadow:none;
      transition: none;
    }
    .flip-btns {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top:7px;
      margin-bottom:7px;
    }
    .flip-btns button {
      width: 100%;
      padding: 5px 0;
      margin: 0;
      background: #111;
      color: #39ff14;
      border: 1px solid #39ff14;
      border-radius: 3px;
      font-size: 13px;
      cursor:pointer;
    }
    .flip-btns button:active {
      background:#333;
    }
    #import-cancel-btn, #import-stamp-btn {
      margin-right: 10px;
      margin-top: 7px;
      margin-bottom: 7px;
    }
    @media (max-width:900px){
      #import-preview-img{max-width:90vw;max-height:60vh;}
    }
    .rotation-control {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
      margin-bottom: 2px;
    }
    .rotation-control input[type="number"].no-arrows {
      width: 45px;
      background: #000;
      border: 1px solid #39ff14;
      color: #39ff14;
      font-size: 13px;
      text-align: right;
      padding:2px 4px;
      margin-left: 2px;
    }
    #text-preview-overlay {
      position: absolute;
      z-index: 6;
      pointer-events: auto;
      user-select: none;
      cursor: grab;
      min-width: 10px;
      min-height: 10px;
      will-change: transform;
      display: none;
      border: 2px solid #f00 !important;
      box-shadow: 0 0 0 2px #f00;
      background: transparent;
      opacity: 0.5;
      padding: 0;
      margin: 0;
      box-sizing: border-box;
      transform-origin: center center;
    }
    #text-preview-content {
      font-weight: 700;
      display: inline-block;
      background: transparent;
      color: #000;
      pointer-events: none;
      user-select: none;
      padding: 0;
      margin: 0;
      min-width: 10px;
      min-height: 10px;
      font-family: inherit;
      font-size: inherit;
      white-space: pre;
    }
    #text-toolbox-controls {
      display: flex;
      flex-direction: row;
      gap: 8px;
      margin-top: 7px;
      margin-bottom: 7px;
    }
    #text-toolbox-controls button {
      font-size:13px;
      background:#111;
      color:#39ff14;
      border:1px solid #39ff14;
      border-radius:3px;
      padding:3px 10px;
      cursor:pointer;
    }
    #text-toolbox-controls button:active {
      background:#333;
    }
    .text-rotation-wrapper,.text-size-wrapper {
      margin-top: 7px;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .text-rotation-wrapper label,.text-size-wrapper label {
      margin-right: 4px;
    }
    .text-rotation-wrapper input[type="number"].no-arrows,
    .text-size-wrapper input[type="number"].no-arrows {
      width: 45px;
      background: #000;
      border: 1px solid #39ff14;
      color: #39ff14;
      font-size: 13px;
      text-align: right;
      padding:2px 4px;
    }

    /* New layer and filter UI styles */
    .layers-grid{
      display:flex;
      gap:6px;
      align-items:center;
      margin-top:6px;
    }
    .layer-cell{
      min-width:90px;
      padding:6px;
      background:#111;
      border:2px solid #222;
      color:#ccc;
      text-align:center;
      cursor:pointer;
      border-radius:4px;
    }
    .layer-cell.active{
      border-color:#39ff14;
      background:#0a0a0a;
      color:#39ff14;
    }
    .layers-controls{
      display:flex;
      gap:6px;
      margin-top:6px;
      align-items:center;
    }
    .filters-grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:8px;
      margin-top:6px;
    }
    .filter-btn{
      background:#000;
      border:2px solid #39ff14;
      color:#39ff14;
      padding:8px;
      border-radius:4px;
      cursor:pointer;
      text-align:center;
    }
    .select-info{font-size:12px;color:#aaa;margin-top:6px;}
    /* selection preview overlay */
    #selection-preview{
      position:absolute;
      z-index:7;
      display:none;
      pointer-events:auto;
      border:2px dashed #39ff14;
      background:transparent;
      opacity:0.9;
      transform-origin:center center;
    }
    #selection-preview img{display:block;max-width:none;max-height:none;pointer-events:none;}
  </style>
</head>
<body>
<center><img src="ppt.png" width="13%"></center>
<div id="app-container">
<canvas id="paint-canvas"></canvas>
<div id="tool-panel">
<div class="menu-title" id="tool-panel-header" data-menu="tools">-tools</div>
<div class="dropdown hidden" id="tools-dropdown">
  <div class="tool-option" id="marker-option">-marker</div>
  <div class="tool-settings hidden" id="marker-settings">
    <label>size: <input type="number" id="marker-size" min="1" max="25" value="3"></label><br>
    <label>color: <input type="color" id="color-picker"></label><br>
    <label>flow: <input type="range" id="marker-flow" min="1" max="3000" value="2500"></label>
  </div>
  <div class="tool-option" id="calligraphy-option">-calligraphy</div>
  <div class="tool-settings hidden" id="calligraphy-settings">
    <label>size: <input type="number" id="calligraphy-size" min="1" max="64" value="20"></label><br>
    <label>color: <input type="color" id="calligraphy-color" value="#000000"></label><br>
    <label>flow: <input type="range" id="calligraphy-flow" min="1" max="3000" value="2500"></label><br>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-width:112px;">
        <button class="calligraphy-btn calligraphy-selected force-plain-text" data-calligraphy="♥&#xFE0E;" title="Heart">♥&#xFE0E;</button>
        <button class="calligraphy-btn force-plain-text" data-calligraphy="⎸&#xFE0E;" title="Medium Vertical Bar">⎸&#xFE0E;</button>
        <button class="calligraphy-btn force-plain-text" data-calligraphy="✦&#xFE0E;" title="Four Pointed Star">✦&#xFE0E;</button>
        <button class="calligraphy-btn force-plain-text" data-calligraphy="◢&#xFE0E;" title="Black Right-Pointing Triangle">◢&#xFE0E;</button>
        <button class="calligraphy-btn force-plain-text" data-calligraphy="◣&#xFE0E;" title="Black Lower-Left Triangle">◣&#xFE0E;</button>
        <button class="calligraphy-btn force-plain-text" data-calligraphy="♦&#xFE0E;" title="Diamond">♦&#xFE0E;</button>
      </div>
  </div>
  <div class="tool-option" id="symbol-option">-symbol</div>
  <div class="tool-settings hidden" id="symbol-settings">
    <label>size: <input type="number" id="symbol-size" min="1" max="150" value="35"></label><br>
    <label>color: <input type="color" id="symbol-color" value="#000000"></label><br>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-width:112px;">
      <button class="symbol-btn symbol-selected force-plain-text" data-symbol="★&#xFE0E;" title="Black Star">★&#xFE0E;</button>
      <button class="symbol-btn force-plain-text" data-symbol="☠&#xFE0E;" title="Skull">☠&#xFE0E;</button>
      <button class="symbol-btn force-plain-text" data-symbol="☣&#xFE0E;" title="Biohazard">☣&#xFE0E;</button>
      <button class="symbol-btn force-plain-text" data-symbol="✠&#xFE0E;" title="Maltese Cross">✠&#xFE0E;</button>
      <button class="symbol-btn force-plain-text" data-symbol="☭&#xFE0E;" title="Hammer and Sickle">☭&#xFE0E;</button>
      <button class="symbol-btn force-plain-text" data-symbol="☮&#xFE0E;" title="Peace">☮&#xFE0E;</button>
    </div>
  </div>
  <div class="tool-option" id="text-option">-text</div>
  <div class="tool-settings hidden" id="text-settings">
    <div id="font-dropdown" class="font-dropdown" tabindex="0">
      <div class="font-dropdown-selected" id="font-dropdown-selected">
        <span id="font-dropdown-selected-name" style="font-family: Arial;">Arial</span>
        <span class="font-dropdown-arrow">&#9660;</span>
      </div>
      <div class="font-dropdown-list" id="font-dropdown-list">
        <div class="font-dropdown-option" style="font-family: Arial;" data-font="Arial">Arial</div>
        <div class="font-dropdown-option" style="font-family: 'Courier New', Courier, monospace;" data-font="'Courier New', Courier, monospace">Courier New</div>
        <div class="font-dropdown-option" style="font-family: 'Times New Roman', Times, serif;" data-font="'Times New Roman', Times, serif">Times New Roman</div>
        <div class="font-dropdown-option" style="font-family: 'Roboto Mono', monospace;" data-font="'Roboto Mono', monospace">Roboto Mono</div>
        <div class="font-dropdown-option" style="font-family: 'Comic Sans MS', cursive, sans-serif;" data-font="'Comic Sans MS', cursive, sans-serif">Comic Sans MS</div>
        <div class="font-dropdown-option" style="font-family: 'Georgia', serif;" data-font="Georgia, serif">Georgia</div>
        <div class="font-dropdown-option" style="font-family: 'Impact', fantasy;" data-font="Impact, fantasy">Impact</div>
        <div class="font-dropdown-option" style="font-family: Helvetica, Arial, sans-serif;" data-font="Helvetica, Arial, sans-serif">Helvetica</div>
        <div class="font-dropdown-option" style="font-family: Papyrus, fantasy;" data-font="Papyrus, fantasy">Papyrus</div>
        <div class="font-dropdown-option" style="font-family: Stencil, fantasy;" data-font="Stencil, fantasy">Stencil</div>
        <div class="font-dropdown-option" style="font-family: Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;" data-font="Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace">Menlo</div>
        <div class="font-dropdown-option" style="font-family: 'Verdana', sans-serif;" data-font="Verdana, sans-serif">Verdana</div>
        <div class="font-dropdown-option" style="font-family: 'Trebuchet MS', sans-serif;" data-font="'Trebuchet MS', sans-serif">Trebuchet MS</div>
        <div class="font-dropdown-option" style="font-family: 'Eagle Lake', cursive;" data-font="'Eagle Lake', cursive">Eagle Lake</div>
        <div class="font-dropdown-option" style="font-family: 'Jacquard 24', cursive;" data-font="'Jacquard 24', cursive">Jacquard 24</div>
        <div class="font-dropdown-option" style="font-family: 'Lucida Console', Monaco, monospace;" data-font="'Lucida Console', Monaco, monospace">Lucida Console</div>
      </div>
    </div><br>
    <div class="text-size-wrapper">
      <label for="text-size-range">size:</label>
      <input type="range" id="text-size-range" min="8" max="150" value="32" style="width:90px;">
      <input type="number" id="text-size" min="8" max="150" value="32" class="no-arrows">
    </div>
    <div class="text-rotation-wrapper">
      <label for="text-rotation-range">rotation:</label>
      <input type="range" id="text-rotation-range" min="-180" max="180" value="0" style="width:90px;">
      <input type="number" id="text-rotation-number" min="-180" max="180" value="0" class="no-arrows">
    </div>
    <label>color: <input type="color" id="text-color" value="#000000"></label><br>
    <textarea id="text-string" rows="2" style="width:95%;resize:vertical;background-color: #000;">your text</textarea>
    <div id="text-toolbox-controls" style="display:flex;">
      <button id="text-submit-btn">submit</button>
      <button id="text-cancel-btn">cancel</button>
    </div>
  </div>
  <div class="tool-option" id="spray-option">-spray</div>
  <div class="tool-settings hidden" id="spray-settings">
    <label>size: <input type="number" id="spray-size" min="1" max="25" value="3"></label><br>
    <label>spread: <input type="range" id="spray-spread" min="1" max="50" value="16"></label><br>
    <label>flow: <input type="range" id="spray-flow" min="1" max="100" value="50"></label><br>
    <label>color: <input type="color" id="spray-color"></label>
  </div>
  <div class="tool-option" id="bucket-option">-bucket</div>
  <div class="tool-settings hidden" id="bucket-settings">
    <label>color: <input type="color" id="bucket-color"></label>
  </div>
  <div class="tool-option" id="eraser-option">-eraser</div>
  <div class="tool-settings hidden" id="eraser-settings">
    <label>size: <input type="number" id="eraser-size" min="1" max="25" value="3"></label>
  </div>
  <div class="tool-option clear-tool" id="clear-option">-clear</div>
  <div class="tool-settings hidden" id="clear-settings">
    <div class="clear-settings">
      <button id="clear-yes">yes</button>
      <button id="clear-back">back</button>
    </div>
  </div>
</div>

<!-- New Edit dropdown -->
<div class="menu-title" data-menu="edit">-edit</div>
<div class="dropdown hidden" id="edit-dropdown">
  <!-- Layers UI -->
  <div style="font-size:13px;text-transform:lowercase;">- layers</div>
  <div class="layers-grid" id="layers-grid"></div>
  <div class="layers-controls">
    <button id="layer-add">+</button>
    <button id="layer-remove">-</button>
    <div style="margin-left:auto;color:#aaa;" id="layer-count">1/5</div>
  </div>

  <!-- Filters UI -->
  <div style="font-size:13px;text-transform:lowercase;margin-top:8px;">- filters</div>
  <div class="filters-grid">
    <button class="filter-btn" id="filter-invert">invert</button>
    <button class="filter-btn" id="filter-bw">b&w</button>
    <button class="filter-btn" id="filter-blur">blur</button>
    <button class="filter-btn" id="filter-sharpen">sharpen</button>
  </div>

  <!-- Select UI -->
  <div style="font-size:13px;text-transform:lowercase;margin-top:8px;">- select</div>
  <div class="tool-settings">
    <div class="select-info">Use the rectangular marquee to select an area on the active layer. After selection you can move/scale/rotate the selection. Click the canvas to start selecting.</div>
    <div style="margin-top:6px;">
      <button id="select-cancel">cancel selection</button>
      <button id="select-commit">stamp selection</button>
    </div>
  </div>
</div>

<div class="menu-title" data-menu="import">-import</div>
<div class="dropdown hidden" id="import-dropdown">
  <label class="import-label" for="import-image-file">upload<input type="file" id="import-image-file" accept="image/*"></label>
  <div id="import-settings" class="hidden" style="margin-top:6px;">
    <label>size: <input type="range" id="import-size" min="1" max="400" value="50" style="width:90px;"> <span id="import-size-value">50</span>%</label><br>
    <label>opacity: <input type="range" id="import-opacity" min="10" max="100" value="75" style="width:90px;"> <span id="import-opacity-value">75</span>%</label><br>
    <div class="rotation-control">
      <label for="import-rotation">rotation:</label>
      <input type="range" id="import-rotation" min="-180" max="180" value="0" style="width:90px;">
      <input type="number" id="import-rotation-number" min="-180" max="180" value="0" class="no-arrows">
    </div>
    <div class="flip-btns">
      <button id="import-flip-h">flip horizontal</button>
      <button id="import-flip-v">flip vertical</button>
    </div>
    <button id="import-stamp-btn">submit</button>
    <button id="import-cancel-btn">cancel</button>
    <div style="font-size:11px;color:#aaa;margin-top:3px;">drag image to position, then stamp</div>
  </div>
</div>
<div id="text-preview-overlay">
  <div id="text-preview-content"></div>
</div>

<!-- selection preview overlay -->
<div id="selection-preview"><img id="selection-preview-img"></div>

<div class="menu-title" data-menu="export">-export</div>
<div class="dropdown hidden" id="export-dropdown">
  <label class="export-settings">file name: <input type="text" id="file-name" value="pixel-art"></label><br>
  <label class="export-settings"><input type="checkbox" id="transparent-bg" checked> transparent background</label><br>
  <button class="export-settings" id="export-btn">save</button>
  <button class="export-settings" id="export-back">back</button>
</div>
<div class="menu-title" id="undo-btn">-undo</div>
</div>
</div>
<script>
/*
  Major changes:
  - Added -edit dropdown with Layers (1-5), Filters, and Select tool
  - Implemented per-layer canvases (up to 5), active layer selection and highlighting
  - Drawing, text, import, bucket, etc. are applied to the active layer
  - Composite rendering onto the visible main canvas
  - Undo now stores per-layer snapshots and active layer index
  - Selection tool: rectangular marquee -> floating transformable selection (scale/rotate) -> stamp back to active layer
  - Filters (invert, b&w, blur, sharpen) apply to active layer
  - Preserved earlier fixes: restored marker/spray/eraser implementations, text placement center fix
*/

const canvas = document.getElementById('paint-canvas'), mainCtx = canvas.getContext('2d');
canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; mainCtx.imageSmoothingEnabled = false;

let MAX_UNDO = 20;
let undoStack = [];

// Layers: up to 5
const MAX_LAYERS = 5;
let layers = []; // each item: {canvas, ctx}
let activeLayerIndex = 0;

// Create a layer canvas sized to main canvas, initially transparent
function createLayer() {
  const c = document.createElement('canvas');
  c.width = canvas.width;
  c.height = canvas.height;
  const cctx = c.getContext('2d');
  cctx.imageSmoothingEnabled = false;
  // initially transparent
  cctx.clearRect(0,0,c.width,c.height);
  layers.push({canvas: c, ctx: cctx});
  updateLayerUI();
  renderComposite();
  return layers.length - 1;
}

function removeLayer(index) {
  if (layers.length <= 1) return;
  layers.splice(index,1);
  if (activeLayerIndex >= layers.length) activeLayerIndex = layers.length-1;
  updateLayerUI();
  renderComposite();
}

// Composite all layers in order onto the main canvas
function renderComposite() {
  mainCtx.clearRect(0,0,canvas.width,canvas.height);
  // Draw layers in order
  for (let i=0;i<layers.length;i++){
    mainCtx.drawImage(layers[i].canvas, 0, 0);
  }
}

// Ensure we draw to active layer context for painting operations
function getActiveCtx() {
  return layers[activeLayerIndex].ctx;
}

// Undo system: save snapshot of all layers (ImageData) and active index
function saveState() {
  try {
    const snapshot = {
      activeIndex: activeLayerIndex,
      layersData: layers.map(l => l.ctx.getImageData(0,0,canvas.width,canvas.height))
    };
    if (undoStack.length >= MAX_UNDO) undoStack.shift();
    undoStack.push(snapshot);
  } catch (e) {
    // Some operations (CORS) can taint canvas; ignore but don't crash
    console.warn("saveState failed:", e);
  }
}
function undo() {
  if (undoStack.length === 0) return;
  const snapshot = undoStack.pop();
  // restore each layer imageData
  for (let i=0;i<layers.length && i<snapshot.layersData.length;i++){
    layers[i].ctx.putImageData(snapshot.layersData[i], 0, 0);
  }
  // if snapshot had more layers than current, ignore extras; if fewer, clear remaining
  for (let i=snapshot.layersData.length;i<layers.length;i++){
    layers[i].ctx.clearRect(0,0,canvas.width,canvas.height);
  }
  activeLayerIndex = Math.min(snapshot.activeIndex, layers.length-1);
  updateLayerUI();
  renderComposite();
}

// Resize handling - scale layer contents to new size
function resizeCanvasAndLayers() {
  const r = canvas.getBoundingClientRect();
  const newW = Math.round(r.width);
  const newH = Math.round(r.height);
  // For each layer, draw into temp then resize and draw back
  layers.forEach((l)=> {
    const temp = document.createElement('canvas');
    temp.width = newW;
    temp.height = newH;
    const tctx = temp.getContext('2d');
    tctx.imageSmoothingEnabled = false;
    // draw existing content scaled to new size
    tctx.drawImage(l.canvas, 0, 0, newW, newH);
    l.canvas.width = newW;
    l.canvas.height = newH;
    l.ctx = l.canvas.getContext('2d');
    l.ctx.imageSmoothingEnabled = false;
    l.ctx.drawImage(temp, 0, 0);
  });
  canvas.width = newW;
  canvas.height = newH;
  mainCtx.imageSmoothingEnabled = false;
  renderComposite();
}

// initial single layer
createLayer();

// basic tool state
let drawing = false, currentTool = 'marker';
let markerSize = 3, eraserSize = 3, color = '#000000', bucketColor = '#000000', flow = 2500;
let spraySize = 3, spraySpread = 16, sprayFlow = 50, sprayColor = '#000000';
let calligraphySize = 20, calligraphyFlow = 2500, calligraphyBrushType = 0, calligraphyColor = '#000000';
let symbolSize = 35, symbolCharType = 0, symbolColor = '#000000';
let textFont="Arial", textSize=32, textColor="#000000", textString="your text";
const calligraphyBrushes=[ "♥\uFE0E", "⎸\uFE0E", "✦\uFE0E", "◢\uFE0E", "◣\uFE0E", "♦\uFE0E" ];
const symbolChars=[ "★\uFE0E", "☠\uFE0E", "☣\uFE0E", "✠\uFE0E", "☭\uFE0E", "☮\uFE0E" ];

// UI hooks
document.querySelectorAll('.calligraphy-btn').forEach((btn,i)=>{btn.onclick=()=>{document.querySelectorAll('.calligraphy-btn').forEach(b=>b.classList.remove('calligraphy-selected'));btn.classList.add('calligraphy-selected');calligraphyBrushType=i;}});
document.querySelectorAll('.symbol-btn').forEach((btn,i)=>{btn.onclick=()=>{document.querySelectorAll('.symbol-btn').forEach(b=>b.classList.remove('symbol-selected'));btn.classList.add('symbol-selected');symbolCharType=i;}});
document.getElementById('marker-size').oninput=e=>{markerSize=+e.target.value;};
document.getElementById('marker-flow').oninput=e=>{flow=+e.target.value;};
document.getElementById('color-picker').oninput=e=>color=e.target.value;
document.getElementById('calligraphy-size').oninput=e=>{calligraphySize=+e.target.value;};
document.getElementById('calligraphy-flow').oninput=e=>{calligraphyFlow=+e.target.value;};
document.getElementById('calligraphy-color').oninput=e=>{calligraphyColor=e.target.value;};
document.getElementById('symbol-size').oninput=e=>symbolSize=+e.target.value;
document.getElementById('symbol-color').oninput=e=>{symbolColor=e.target.value;};

// Font dropdown & text UI
const fontDropdown=document.getElementById("font-dropdown"), fontDropdownList=document.getElementById("font-dropdown-list"), fontDropdownSelectedName=document.getElementById("font-dropdown-selected-name");
Array.from(fontDropdownList.children).forEach(opt=>{opt.onclick=function(){Array.from(fontDropdownList.children).forEach(o=>o.classList.remove("selected"));this.classList.add("selected");textFont = this.getAttribute("data-font");fontDropdownSelectedName.textContent = this.textContent;fontDropdownSelectedName.style.fontFamily = textFont;fontDropdown.classList.remove("open");if(textPreviewActive) updateTextPreviewContent(textString, textFont, textSize, textColor);};});
document.getElementById("font-dropdown-selected").onclick = function(){fontDropdown.classList.toggle("open");};
fontDropdown.onblur=function(){fontDropdown.classList.remove("open");};

const textSizeRange=document.getElementById('text-size-range'), textSizeInput=document.getElementById('text-size');
function setTextSize(v){v=Math.max(8,Math.min(150,Number(v)||32));textSize=v;textSizeRange.value=v;textSizeInput.value=v;if(textPreviewActive)updateTextPreviewContent(textString,textFont,textSize,textColor);}
textSizeRange.addEventListener('input',function(){setTextSize(this.value);});
textSizeInput.addEventListener('input',function(){setTextSize(this.value);});
document.getElementById('text-color').oninput=e=>{textColor=e.target.value;if(textPreviewActive) updateTextPreviewContent(textString, textFont, textSize, textColor);}
document.getElementById('text-string').oninput=e=>{textString=e.target.value;if(textPreviewActive) updateTextPreviewContent(textString, textFont, textSize, textColor);};

// calligraphy & symbol draw functions use activeCtx
function drawCalligraphy(x,y){
  const ctx = getActiveCtx();
  ctx.save();
  ctx.font = `${calligraphySize}px 'Roboto Mono', 'DejaVu Sans Mono', 'Liberation Mono', 'Consolas', 'Courier', 'monospace', 'Arial', 'sans-serif'`;
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillStyle = calligraphyColor;
  ctx.globalCompositeOperation = 'source-over';
  ctx.fillText(calligraphyBrushes[calligraphyBrushType], x, y);
  ctx.restore();
}
function drawCalligraphyFlowLine(x0,y0,x1,y1){
  let dx=Math.abs(x1-x0),dy=Math.abs(y1-y0),sx=x0<x1?1:-1,sy=y0<y1?1:-1,err=dx-dy;
  while(true){
    drawCalligraphy(x0,y0);
    if(x0===x1&&y0===y1)break;
    let e2=2*err;if(e2>-dy){err-=dy;x0+=sx;}if(e2<dx){err+=dx;y0+=sy;}
  }
}
function drawSymbol(x,y){
  const ctx = getActiveCtx();
  ctx.save();
  ctx.font = `${symbolSize}px 'Roboto Mono', 'DejaVu Sans Mono', 'Liberation Mono', 'Consolas', 'Courier', 'monospace', 'Arial', 'sans-serif'`;
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillStyle = symbolColor;
  ctx.globalCompositeOperation = 'source-over';
  ctx.fillText(symbolChars[symbolCharType], x, y);
  ctx.restore();
}

// Text preview overlay & placement (kept the earlier "center of DOM text" approach)
function getTextBBox(text,font,size){
  const off=document.createElement('canvas');
  const offCtx=off.getContext('2d');
  offCtx.font=`${size}px ${font}`;
  const lines=text.split('\n');
  let width=0;
  for(let l of lines){const m=offCtx.measureText(l);width=Math.max(width,m.width);}
  return {width,height:lines.length*size*1.15};
}
const textPreviewOverlay=document.getElementById('text-preview-overlay');
const textPreviewContent=document.getElementById('text-preview-content');
const textSubmitBtn=document.getElementById('text-submit-btn');
const textCancelBtn=document.getElementById('text-cancel-btn');
const textToolboxControls=document.getElementById('text-toolbox-controls');
const textRotationRange=document.getElementById('text-rotation-range');
const textRotationNumber=document.getElementById('text-rotation-number');
let textPreviewActive=false,textPreviewDragging=false,textPreviewOffsetX=0,textPreviewOffsetY=0,textPreviewPosX=0,textPreviewPosY=0,textPreviewInit=false,textPreviewInitX=0,textPreviewInitY=0,textRotation=0;
function showTextPreviewOverlay(text,font,size,color,forceCenter){
  textPreviewActive=true;textPreviewOverlay.style.display="block";textPreviewOverlay.style.boxSizing="border-box";
  textPreviewContent.textContent=text.replace(/\n/g,"\n");
  textPreviewOverlay.style.fontFamily=font;textPreviewOverlay.style.fontSize=size+"px";textPreviewOverlay.style.color=color;
  textPreviewContent.style.fontFamily=font;textPreviewContent.style.fontSize=size+"px";textPreviewContent.style.color=color;
  let box=getTextBBox(text,font,size);
  textPreviewOverlay.style.width=box.width+"px";textPreviewOverlay.style.height=box.height+"px";
  textPreviewOverlay.style.transformOrigin="center center";
  if(forceCenter||!textPreviewInit){
    let container=document.getElementById('app-container');
    textPreviewPosX=(container.offsetWidth-box.width)/2;
    textPreviewPosY=(container.offsetHeight-box.height)/2;
    textPreviewInitX=textPreviewPosX;textPreviewInitY=textPreviewPosY;textPreviewInit=true;
  }
  textPreviewOverlay.style.left=textPreviewPosX+"px";
  textPreviewOverlay.style.top=textPreviewPosY+"px";
  textToolboxControls.style.display="flex";
  updateTextPreviewTransform();
}
function updateTextPreviewContent(text,font,size,color){
  textPreviewContent.textContent=text.replace(/\n/g,"\n");
  textPreviewOverlay.style.fontFamily=font;textPreviewOverlay.style.fontSize=size+"px";textPreviewOverlay.style.color=color;
  textPreviewContent.style.fontFamily=font;textPreviewContent.style.fontSize=size+"px";textPreviewContent.style.color=color;
  let box=getTextBBox(text,font,size);
  textPreviewOverlay.style.width=box.width+"px";textPreviewOverlay.style.height=box.height+"px";
  textPreviewOverlay.style.left=textPreviewPosX+"px";textPreviewOverlay.style.top=textPreviewPosY+"px";
  updateTextPreviewTransform();
}
function updateTextPreviewTransform(){textPreviewOverlay.style.transform=`rotate(${textRotation}deg)`;}
function hideTextPreviewOverlay(){textPreviewActive=false;textPreviewOverlay.style.display="none";textToolboxControls.style.display="none";textPreviewInit=false;textPreviewPosX=0;textPreviewPosY=0;}
textPreviewOverlay.onmousedown=function(e){e.preventDefault();textPreviewDragging=true;textPreviewOverlay.style.cursor='grabbing';let rect=textPreviewOverlay.getBoundingClientRect();textPreviewOffsetX=e.clientX-rect.left;textPreviewOffsetY=e.clientY-rect.top;};
textPreviewOverlay.ontouchstart=function(e){if(e.touches.length!==1)return;e.preventDefault();textPreviewDragging=true;textPreviewOverlay.style.cursor='grabbing';let rect=textPreviewOverlay.getBoundingClientRect();let t=e.touches[0];textPreviewOffsetX=t.clientX-rect.left;textPreviewOffsetY=t.clientY-rect.top;};
document.addEventListener('mousemove',function(e){if(!textPreviewDragging||!textPreviewActive)return;let containerRect=document.getElementById('app-container').getBoundingClientRect();let mouseX=e.clientX-containerRect.left,mouseY=e.clientY-containerRect.top,posX=mouseX-textPreviewOffsetX,posY=mouseY-textPreviewOffsetY;textPreviewPosX=posX;textPreviewPosY=posY;textPreviewOverlay.style.left=textPreviewPosX+"px";textPreviewOverlay.style.top=textPreviewPosY+"px";});
document.addEventListener('mouseup',function(){textPreviewDragging=false;textPreviewOverlay.style.cursor='grab';});
document.addEventListener('touchmove',function(e){if(!textPreviewDragging||!textPreviewActive)return;let containerRect=document.getElementById('app-container').getBoundingClientRect();let t=e.touches[0];let touchX=t.clientX-containerRect.left,touchY=t.clientY-containerRect.top,posX=touchX-textPreviewOffsetX,posY=touchY-textPreviewOffsetY;textPreviewPosX=posX;textPreviewPosY=posY;textPreviewOverlay.style.left=textPreviewPosX+"px";textPreviewOverlay.style.top=textPreviewPosY+"px";if(e.cancelable)e.preventDefault();},{passive:false});
document.addEventListener('touchend',function(){textPreviewDragging=false;textPreviewOverlay.style.cursor='grab';});
function setTextRotation(val){let v=Math.max(-180,Math.min(180,Number(val)||0));textRotation=v;textRotationRange.value=v;textRotationNumber.value=v;updateTextPreviewTransform();}
textRotationRange.addEventListener('input',function(){setTextRotation(this.value);});
textRotationNumber.addEventListener('input',function(){setTextRotation(this.value);});

// Submit text: stamp to active layer using the DOM preview center for pixel-perfect alignment (kept from earlier patch)
textSubmitBtn.onclick=function(){
  if(!textPreviewActive)return;
  saveState();
  let contentElem = document.getElementById('text-preview-content');
  let contentRect = contentElem.getBoundingClientRect();
  let canvasRect = canvas.getBoundingClientRect();
  let centerX = contentRect.left + contentRect.width/2;
  let centerY = contentRect.top + contentRect.height/2;
  let px = (centerX - canvasRect.left) * (canvas.width / canvasRect.width);
  let py = (centerY - canvasRect.top) * (canvas.height / canvasRect.height);
  const ctx = getActiveCtx();
  ctx.save();
  ctx.translate(px,py);
  ctx.rotate(textRotation*Math.PI/180);
  ctx.font = `${textSize}px ${textFont}`;
  ctx.fillStyle = textColor;
  ctx.textBaseline = "middle";
  ctx.textAlign = "center";
  let lines=textString.split('\n');
  let blockHeight = lines.length * textSize * 1.15;
  let offsetY = -blockHeight/2 + textSize*1.15/2;
  for(let i=0;i<lines.length;i++){
    ctx.fillText(lines[i], 0, offsetY + i*textSize*1.15);
  }
  ctx.restore();
  // refresh visible composite
  renderComposite();
  // Reset text preview position
  showTextPreviewOverlay(textString,textFont,textSize,textColor,false);
  textPreviewPosX=textPreviewInitX;textPreviewPosY=textPreviewInitY;
  textPreviewOverlay.style.left=textPreviewPosX+"px";
  textPreviewOverlay.style.top=textPreviewPosY+"px";
};
textCancelBtn.onclick=hideTextPreviewOverlay;

// Basic restored marker/spray/eraser implementations (applied to active layer ctx)
function drawAt(x, y) {
  const ctx = getActiveCtx();
  ctx.save();
  if (currentTool === "eraser") {
    // Erase to transparent
    ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath();
    ctx.arc(x, y, eraserSize / 2, 0, 2 * Math.PI);
    ctx.fillStyle = 'rgba(0,0,0,1)';
    ctx.fill();
  } else {
    ctx.globalCompositeOperation = 'source-over';
    ctx.beginPath();
    ctx.arc(x, y, markerSize / 2, 0, 2 * Math.PI);
    ctx.fillStyle = color;
    ctx.fill();
  }
  ctx.restore();
}

function drawLine(x0, y0, x1, y1) {
  const ctx = getActiveCtx();
  ctx.save();
  ctx.strokeStyle = currentTool === "eraser" ? "rgba(0,0,0,1)" : color;
  ctx.lineWidth = currentTool === "eraser" ? eraserSize : markerSize;
  ctx.lineCap = "round";
  if (currentTool === "eraser") ctx.globalCompositeOperation = 'destination-out'; else ctx.globalCompositeOperation = 'source-over';
  ctx.beginPath();
  ctx.moveTo(x0, y0);
  ctx.lineTo(x1, y1);
  ctx.stroke();
  ctx.restore();
}

function sprayAt(x, y) {
  const ctx = getActiveCtx();
  ctx.save();
  ctx.fillStyle = sprayColor;
  ctx.globalCompositeOperation = 'source-over';
  for (let i = 0; i < sprayFlow; i++) {
    const angle = Math.random() * 2 * Math.PI;
    const radius = Math.random() * spraySpread;
    ctx.beginPath();
    ctx.arc(
      x + Math.cos(angle) * radius,
      y + Math.sin(angle) * radius,
      spraySize / 2,
      0,
      2 * Math.PI
    );
    ctx.fill();
  }
  ctx.restore();
}

// Mouse/touch event handlers for tools (paint into active layer then composite)
let lastPos = null;
canvas.addEventListener('mousedown',e=>{
  const r=canvas.getBoundingClientRect(),
        x=Math.floor((e.clientX-r.left)*canvas.width/r.width),
        y=Math.floor((e.clientY-r.top)*canvas.height/r.height);
  if(currentTool==='bucket'){
    saveState();
    floodFillActiveLayer(x,y,bucketColor);
  }else if(currentTool==='select'){
    // start selection marquee
    startSelection(e.clientX, e.clientY);
  }else{
    saveState();
    if(currentTool==='calligraphy'){
      drawing=true;lastPos={x,y};drawCalligraphy(x,y);renderComposite();
    }else if(currentTool==='symbol'){
      drawSymbol(x,y);renderComposite();
    }else if(currentTool==='text'){
      // do nothing (text handled via overlay)
    }else if(currentTool==='spray'){
      drawing=true;lastPos={x,y};sprayAt(x,y);renderComposite();
    }else if(currentTool==='eraser' || currentTool==='marker'){
      drawing=true;lastPos={x,y};drawAt(x,y);renderComposite();
    }
  }
});
canvas.addEventListener('mousemove',e=>{
  if(!drawing||currentTool==='bucket'||currentTool==='symbol'||currentTool==='text'||currentTool==='select')return;
  const r=canvas.getBoundingClientRect(),
        x=Math.floor((e.clientX-r.left)*canvas.width/r.width),
        y=Math.floor((e.clientY-r.top)*canvas.height/r.height);
  if(currentTool==='calligraphy'){
    if(lastPos){
      if(calligraphyFlow>=1000){
        drawCalligraphyFlowLine(lastPos.x,lastPos.y,x,y);
      }else{
        let dist=Math.hypot(x-lastPos.x,y-lastPos.y);
        let step=Math.max(1,Math.floor(1000/calligraphyFlow));
        if(dist>step){
          let steps=Math.floor(dist/step);
          for(let i=1;i<=steps;i++){
            let nx=Math.round(lastPos.x+(x-lastPos.x)*i/steps),
                ny=Math.round(lastPos.y+(y-lastPos.y)*i/steps);
            drawCalligraphy(nx,ny);
          }
        }else{
          drawCalligraphy(x,y);
        }
      }
    }else{
      drawCalligraphy(x,y);
    }
    renderComposite();
  }else if(currentTool==='spray'){
    sprayAt(x,y);
    renderComposite();
  }else if(currentTool==='eraser' || currentTool==='marker'){
    if(flow>=1000&&lastPos){
      drawLine(lastPos.x,lastPos.y,x,y);
    }else{
      drawAt(x,y);
    }
    renderComposite();
  }
  lastPos={x,y};
});
canvas.addEventListener('mouseup',()=>{drawing=false;});
canvas.addEventListener('mouseout',()=>{drawing=false;});

function getCanvasCoordsTouch(e){
  const r=canvas.getBoundingClientRect(),t=e.touches[0];
  return{
    x:Math.floor((t.clientX-r.left)*canvas.width/r.width),
    y:Math.floor((t.clientY-r.top)*canvas.height/r.height)
  };
}
canvas.addEventListener('touchstart',e=>{
  e.preventDefault();
  const{x,y}=getCanvasCoordsTouch(e);
  if(currentTool==='bucket'){
    saveState();floodFillActiveLayer(x,y,bucketColor);
  }else if(currentTool==='select'){
    startSelection(e.touches[0].clientX, e.touches[0].clientY);
  }else{
    saveState();
    if(currentTool==='calligraphy'){
      drawing=true;lastPos={x,y};drawCalligraphy(x,y);renderComposite();
    }else if(currentTool==='symbol'){
      drawSymbol(x,y);renderComposite();
    }else if(currentTool==='text'){
      // nothing
    }else if(currentTool==='spray'){
      drawing=true;lastPos={x,y};sprayAt(x,y);renderComposite();
    }else if(currentTool==='eraser' || currentTool==='marker'){
      drawing=true;lastPos={x,y};drawAt(x,y);renderComposite();
    }
  }
});
canvas.addEventListener('touchmove',e=>{
  e.preventDefault();
  if(!drawing||currentTool==='bucket'||currentTool==='symbol'||currentTool==='text'||currentTool==='select')return;
  const{x,y}=getCanvasCoordsTouch(e);
  if(currentTool==='calligraphy'){
    if(lastPos){
      if(calligraphyFlow>=1000){
        drawCalligraphyFlowLine(lastPos.x,lastPos.y,x,y);
      }else{
        let dist=Math.hypot(x-lastPos.x,y-lastPos.y);
        let step=Math.max(1,Math.floor(1000/calligraphyFlow));
        if(dist>step){
          let steps=Math.floor(dist/step);
          for(let i=1;i<=steps;i++){
            let nx=Math.round(lastPos.x+(x-lastPos.x)*i/steps),
                ny=Math.round(lastPos.y+(y-lastPos.y)*i/steps);
            drawCalligraphy(nx,ny);
          }
        }else{
          drawCalligraphy(x,y);
        }
      }
    }else{
      drawCalligraphy(x,y);
    }
    renderComposite();
  }else if(currentTool==='spray'){
    sprayAt(x,y);
    renderComposite();
  }else if(currentTool==='eraser' || currentTool==='marker'){
    if(flow>=1000&&lastPos){
      drawLine(lastPos.x,lastPos.y,x,y);
    }else{
      drawAt(x,y);
    }
    renderComposite();
  }
  lastPos={x,y};
},{passive:false});
canvas.addEventListener('touchend',()=>{drawing=false;});

// Bucket fill applied to active layer
function floodFillActiveLayer(x,y,fillHex){
  let layer = layers[activeLayerIndex];
  let imgData;
  try {
    imgData = layer.ctx.getImageData(0,0,canvas.width,canvas.height);
  } catch (e) {
    alert("Bucket fill unavailable: Canvas is tainted (see console). Only use local or CORS-enabled assets.");
    return;
  }
  const targetColor = getPixelColor(x,y,imgData), fillColor = hexToRgb(fillHex).concat(255);
  if(colorsMatch(targetColor,fillColor)) return;
  const stack = [[x,y]];
  while(stack.length){
    const [cx,cy] = stack.pop();
    if(cx<0||cy<0||cx>=canvas.width||cy>=canvas.height) continue;
    const currentColor = getPixelColor(cx,cy,imgData);
    if(!colorsMatch(currentColor,targetColor)) continue;
    const i = (cy*canvas.width+cx)*4;
    imgData.data.set(fillColor, i);
    stack.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);
  }
  layer.ctx.putImageData(imgData,0,0);
  renderComposite();
}
function hexToRgb(hex){const b=parseInt(hex.slice(1),16);return[(b>>16)&255,(b>>8)&255,b&255];}
function getPixelColor(x,y,imgData){const i=(y*imgData.width+x)*4;return[imgData.data[i],imgData.data[i+1],imgData.data[i+2],imgData.data[i+3]];}
function colorsMatch(a,b){return a.every((v,i)=>v===b[i]);}

// ---- import image logic (stamps to active layer now) ----
let importImg=null,importImgNaturalWidth=0,importImgNaturalHeight=0,importPreview=null,importDragging=false,importOffsetX=0,importOffsetY=0,importPosX=0,importPosY=0,importScale=0.5,importRotation=0,importOpacity=0.75,importFlipH=1,importFlipV=1;
const importSettingsDiv=document.getElementById('import-settings'),importFileInput=document.getElementById('import-image-file'),importSizeSlider=document.getElementById('import-size'),importSizeValue=document.getElementById('import-size-value'),importOpacitySlider=document.getElementById('import-opacity'),importOpacityValue=document.getElementById('import-opacity-value'),importRotationSlider=document.getElementById('import-rotation'),importRotationNumber=document.getElementById('import-rotation-number'),importFlipHBtn=document.getElementById('import-flip-h'),importFlipVBtn=document.getElementById('import-flip-v'),importStampBtn=document.getElementById('import-stamp-btn'),importCancelBtn=document.getElementById('import-cancel-btn'),importDropdown=document.getElementById('import-dropdown');
function hideImportPreview(){if(importPreview&&importPreview.parentNode){importPreview.parentNode.removeChild(importPreview);importPreview=null;}}
function showImportPreview(){hideImportPreview();if(!importImg)return;importPreview=document.createElement('img');importPreview.id='import-preview-img';importPreview.src=importImg.src;importPreview.draggable=false;importPreview.style.position='absolute';importPreview.style.opacity=importOpacity.toString();importPreview.style.pointerEvents='auto';importPreview.style.cursor='grab';importPreview.style.zIndex=5;importPreview.style.boxSizing='border-box';let container=document.getElementById('app-container');container.appendChild(importPreview);updateImportPreviewTransform();importPreview.onmousedown=function(e){e.preventDefault();importDragging=true;let rect=importPreview.getBoundingClientRect();importOffsetX=e.clientX-rect.left;importOffsetY=e.clientY-rect.top;};document.addEventListener('mousemove',imagePreviewDragMove);document.addEventListener('mouseup',imagePreviewDragEnd);importPreview.ontouchstart=function(e){if(e.touches.length!==1)return;e.preventDefault();importDragging=true;let rect=importPreview.getBoundingClientRect();let t=e.touches[0];importOffsetX=t.clientX-rect.left;importOffsetY=t.clientY-rect.top;};document.addEventListener('touchmove',imagePreviewDragMove,{passive:false});document.addEventListener('touchend',imagePreviewDragEnd);}
function imagePreviewDragMove(e){if(!importDragging||!importPreview)return;let container=document.getElementById('app-container');let clientX,clientY;if(e.touches&&e.touches.length){clientX=e.touches[0].clientX;clientY=e.touches[0].clientY;}else{clientX=e.clientX;clientY=e.clientY;}let posX=clientX-container.getBoundingClientRect().left-importOffsetX;let posY=clientY-container.getBoundingClientRect().top-importOffsetY;importPosX=posX;importPosY=posY;updateImportPreviewTransform();if(e.cancelable)e.preventDefault();}
function imagePreviewDragEnd(e){if(importDragging){importDragging=false;if(importPreview)importPreview.style.cursor='grab';}}
function updateImportPreviewTransform(){if(!importPreview)return;let w=Math.max(1,Math.round(importImgNaturalWidth*importScale)),h=Math.max(1,Math.round(importImgNaturalHeight*importScale));importPreview.style.width=w+'px';importPreview.style.height=h+'px';importPreview.style.left=importPosX+'px';importPreview.style.top=importPosY+'px';let rot=importRotation,scaleX=importFlipH,scaleY=importFlipV;importPreview.style.transform=`rotate(${rot}deg) scale(${scaleX},${scaleY})`;importPreview.style.opacity=importOpacity;}
function stampImageToActiveLayer(){if(!importImg)return;saveState();let container=document.getElementById('app-container');let w=importPreview.offsetWidth,h=importPreview.offsetHeight;let px=(importPosX)*(canvas.width/container.offsetWidth),py=(importPosY)*(canvas.height/container.offsetHeight);const ctx = getActiveCtx();ctx.save();ctx.globalAlpha=importOpacity;ctx.translate(px+w/2,py+h/2);ctx.rotate(importRotation*Math.PI/180);ctx.scale(importFlipH,importFlipV);ctx.drawImage(importImg,-w/2,-h/2,w,h);ctx.restore();hideImportPreview();importImg=null;importSettingsDiv.classList.add('hidden');renderComposite();}
function importResetState(){importImg=null;importImgNaturalWidth=0;importImgNaturalHeight=0;importScale=0.5;importRotation=0;importOpacity=0.75;importFlipH=1;importFlipV=1;let container=document.getElementById('app-container');importPosX=(container.offsetWidth/2)-50;importPosY=(container.offsetHeight/2)-50;hideImportPreview();importSettingsDiv.classList.add('hidden');}
importFileInput.addEventListener('change',function(e){let file=this.files[0];if(!file)return;importResetState();let reader=new FileReader();reader.onload=function(evt){let img=new window.Image();img.onload=function(){importImg=img;importImgNaturalWidth=img.naturalWidth;importImgNaturalHeight=img.naturalHeight;let container=document.getElementById('app-container');importScale=0.5;importSizeSlider.value=50;importSizeValue.textContent=50;importOpacity=parseInt(importOpacitySlider.value,10)/100.0;importRotation=parseInt(importRotationSlider.value,10);importRotationNumber.value=importRotation;importFlipH=1;importFlipV=1;let w=Math.max(1,Math.round(importImgNaturalWidth*importScale)),h=Math.max(1,Math.round(importImgNaturalHeight*importScale));importPosX=(container.offsetWidth-w)/2;importPosY=(container.offsetHeight-h)/2;importOpacityValue.textContent=importOpacitySlider.value;importSettingsDiv.classList.remove('hidden');showImportPreview();};img.src=evt.target.result;};reader.readAsDataURL(file);});
importSizeSlider.addEventListener('input',function(){importScale=parseInt(this.value,10)/100.0;importSizeValue.textContent=this.value;let container=document.getElementById('app-container');let w=Math.max(1,Math.round(importImgNaturalWidth*importScale)),h=Math.max(1,Math.round(importImgNaturalHeight*importScale));importPosX=(container.offsetWidth-w)/2;importPosY=(container.offsetHeight-h)/2;updateImportPreviewTransform();});
importOpacitySlider.addEventListener('input',function(){importOpacity=parseInt(this.value,10)/100.0;importOpacityValue.textContent=this.value;if(importPreview)importPreview.style.opacity=importOpacity;});
function setImportRotation(val){
  let v=Math.max(-180,Math.min(180,Number(val)||0));
  importRotation=v;
  importRotationSlider.value = v;
  importRotationNumber.value = v;
  updateImportPreviewTransform();
}
importRotationSlider.addEventListener('input',function(){setImportRotation(this.value);});
importRotationNumber.addEventListener('input',function(){setImportRotation(this.value);});
importFlipHBtn.addEventListener('click',function(){importFlipH*=-1;updateImportPreviewTransform();});
importFlipVBtn.addEventListener('click',function(){importFlipV*=-1;updateImportPreviewTransform();});
importStampBtn.addEventListener('click',function(){stampImageToActiveLayer();});
importCancelBtn.addEventListener('click',function(){importResetState();});

// Menu toggles + other UI wiring
document.querySelectorAll('.menu-title').forEach(title=>{title.addEventListener('click',()=>{if(title.id==="undo-btn")return;const menu=title.dataset.menu,dropdown=document.getElementById(`${menu}-dropdown`),isAlreadyOpen=!dropdown.classList.contains('hidden');document.querySelectorAll('.dropdown').forEach(d=>d.classList.add('hidden'));if(!isAlreadyOpen)dropdown.classList.remove('hidden');if(menu!=='import')importResetState();});});
document.getElementById('export-back').addEventListener('click',()=>{document.getElementById('export-dropdown').classList.add('hidden');});
document.getElementById('undo-btn').addEventListener('click',()=>{undo();});
document.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='z')undo();});
document.querySelectorAll('.tool-option').forEach(opt=>{opt.addEventListener('click',()=>{const tool=opt.id.split('-')[0],settings=document.getElementById(`${tool}-settings`);if(currentTool===tool){if(settings)settings.classList.toggle('hidden');return;}currentTool=tool;setToolHighlight(currentTool);if(tool==="text"){showTextPreviewOverlay(textString,textFont,textSize,textColor,true);}else{hideTextPreviewOverlay();}});});
function setToolHighlight(tool){['marker','calligraphy','symbol','text','spray','eraser','bucket','clear'].forEach(t=>{const settings=document.getElementById(`${t}-settings`),option=document.getElementById(`${t}-option`);if(settings)settings.classList.add('hidden');if(option)option.classList.remove('selected');});const settings=document.getElementById(`${tool}-settings`),option=document.getElementById(`${tool}-option`);if(settings)settings.classList.remove('hidden');if(option)option.classList.add('selected');}
document.getElementById('clear-yes').addEventListener('click',()=>{saveState();layers[activeLayerIndex].ctx.clearRect(0,0,canvas.width,canvas.height);document.getElementById('clear-settings').classList.add('hidden');renderComposite();});
document.getElementById('clear-back').addEventListener('click',()=>{document.getElementById('clear-settings').classList.add('hidden');});

// Export now composites layers in order, with transparent option
document.getElementById('export-btn').addEventListener('click',()=>{
  const filename=document.getElementById('file-name').value||'pixel-art',transparent=document.getElementById('transparent-bg').checked;
  const link=document.createElement('a');
  if(!transparent){
    const tempCanvas=document.createElement('canvas');
    tempCanvas.width=canvas.width; tempCanvas.height=canvas.height;
    const tempCtx=tempCanvas.getContext('2d');
    tempCtx.fillStyle="#fff";
    tempCtx.fillRect(0,0,tempCanvas.width,tempCanvas.height);
    layers.forEach(l=> tempCtx.drawImage(l.canvas,0,0));
    link.download=filename+'.png';
    link.href=tempCanvas.toDataURL('image/png');
    link.click();
  } else {
    const tempCanvas=document.createElement('canvas');
    tempCanvas.width=canvas.width; tempCanvas.height=canvas.height;
    const tempCtx=tempCanvas.getContext('2d');
    layers.forEach(l=> tempCtx.drawImage(l.canvas,0,0));
    link.download=filename+'.png';
    link.href=tempCanvas.toDataURL('image/png');
    link.click();
  }
});

// ----------------- Layers UI logic -----------------
const layersGrid = document.getElementById('layers-grid');
const layerAddBtn = document.getElementById('layer-add');
const layerRemoveBtn = document.getElementById('layer-remove');
const layerCountLabel = document.getElementById('layer-count');

function updateLayerUI(){
  layersGrid.innerHTML = '';
  for(let i=0;i<layers.length;i++){
    const cell = document.createElement('div');
    cell.className = 'layer-cell' + (i===activeLayerIndex ? ' active' : '');
    cell.dataset.index = i;
    cell.textContent = `Layer ${i+1}`;
    cell.onclick = ()=>{ activeLayerIndex = i; updateLayerUI(); renderComposite(); if(document.getElementById('edit-dropdown') && !document.getElementById('edit-dropdown').classList.contains('hidden')) showLayerPreviewTransform();};
    layersGrid.appendChild(cell);
  }
  layerCountLabel.textContent = `${activeLayerIndex+1}/${MAX_LAYERS}`;
  // update add/remove enablement
  layerAddBtn.disabled = layers.length >= MAX_LAYERS;
  layerRemoveBtn.disabled = layers.length <= 1;
}

layerAddBtn.addEventListener('click', ()=> {
  if (layers.length >= MAX_LAYERS) return;
  // insert new empty layer on top
  createLayer();
  activeLayerIndex = layers.length - 1;
  updateLayerUI();
  renderComposite();
  showLayerPreviewTransform();
});
layerRemoveBtn.addEventListener('click', ()=> {
  if (layers.length <= 1) return;
  saveState();
  removeLayer(activeLayerIndex);
  updateLayerUI();
  renderComposite();
});

// When edit dropdown open, show preview overlay for active layer with scale/rotation controls
let layerPreviewImg = null;
function showLayerPreviewTransform(){
  // create or update an import-like preview for the active layer
  const container = document.getElementById('app-container');
  // remove existing preview if any
  let existing = document.getElementById('import-preview-img');
  if (existing) existing.remove();
  // create image from layer canvas
  const dataUrl = layers[activeLayerIndex].canvas.toDataURL();
  importImg = new Image();
  importImg.onload = function(){
    importImgNaturalWidth = importImg.naturalWidth;
    importImgNaturalHeight = importImg.naturalHeight;
    importPreview = document.createElement('img');
    importPreview.id='import-preview-img';
    importPreview.src = dataUrl;
    importPreview.draggable=false;
    importPreview.style.position='absolute';
    importPreview.style.opacity='0.9';
    importPreview.style.pointerEvents='auto';
    importPreview.style.cursor='grab';
    importPreview.style.zIndex=5;
    importPreview.style.boxSizing='border-box';
    container.appendChild(importPreview);
    // initial transform state
    importScale = 1.0;
    importSizeSlider.value = Math.round(importScale*100);
    importSizeValue.textContent = importSizeSlider.value;
    importRotation = 0;
    importRotationNumber.value = 0;
    importFlipH = 1; importFlipV = 1;
    importOpacity = 1;
    let w = Math.max(1, Math.round(importImgNaturalWidth*importScale)), h = Math.max(1, Math.round(importImgNaturalHeight*importScale));
    importPosX = (container.offsetWidth - w)/2;
    importPosY = (container.offsetHeight - h)/2;
    updateImportPreviewTransform();
    // enable dragging
    importPreview.onmousedown = function(e){ e.preventDefault(); importDragging=true; let rect=importPreview.getBoundingClientRect(); importOffsetX=e.clientX-rect.left; importOffsetY=e.clientY-rect.top; };
    document.addEventListener('mousemove', imagePreviewDragMove);
    document.addEventListener('mouseup', imagePreviewDragEnd);
  };
  importImg.src = dataUrl;
}

function applyLayerTransformToActiveLayer(){
  // stamp the transformed preview back to the active layer canvas (overwrite whole layer)
  if(!importPreview || !importImg) return;
  saveState();
  const layer = layers[activeLayerIndex];
  // create temp canvas same size as layer
  const temp = document.createElement('canvas');
  temp.width = layer.canvas.width;
  temp.height = layer.canvas.height;
  const tctx = temp.getContext('2d');
  tctx.imageSmoothingEnabled = false;
  // draw transformed importImg onto temp at appropriate scaled size
  const w = importPreview.offsetWidth, h = importPreview.offsetHeight;
  // compute px/py in layer coordinates
  const container = document.getElementById('app-container');
  const px = Math.round(importPosX * (layer.canvas.width / container.offsetWidth));
  const py = Math.round(importPosY * (layer.canvas.height / container.offsetHeight));
  tctx.save();
  tctx.translate(px + (w/2) * (layer.canvas.width / container.offsetWidth), py + (h/2) * (layer.canvas.height / container.offsetHeight));
  tctx.rotate(importRotation * Math.PI / 180);
  // scale to layer pixels
  const scaledW = w * (layer.canvas.width / container.offsetWidth);
  const scaledH = h * (layer.canvas.height / container.offsetHeight);
  tctx.scale(importFlipH, importFlipV);
  // draw image centered
  // convert importImg to an offscreen image scaled to scaledW/scaledH
  tctx.drawImage(importImg, -scaledW/2, -scaledH/2, scaledW, scaledH);
  tctx.restore();
  // replace layer content with temp (we consider transform to be a replacement of entire layer)
  layer.ctx.clearRect(0,0,layer.canvas.width,layer.canvas.height);
  layer.ctx.drawImage(temp,0,0);
  renderComposite();
  hideImportPreview();
  importImg = null;
}

// Hook apply transform button when user is in edit -> layers mode and wants to commit transform
// We'll reuse import-stamp-btn as "apply" when the preview is created via layer preview
importStampBtn.addEventListener('click', function(){
  if(importImg && importPreview && document.getElementById('edit-dropdown') && !document.getElementById('edit-dropdown').classList.contains('hidden')){
    applyLayerTransformToActiveLayer();
  } else {
    stampImageToActiveLayer();
  }
});

// When leaving edit dropdown hide layer preview
document.querySelectorAll('.menu-title').forEach(title=>{
  title.addEventListener('click', ()=>{
    if(title.dataset.menu !== 'edit') {
      // hide layer preview if present
      const existing = document.getElementById('import-preview-img');
      if(existing) existing.remove();
    } else {
      // entering edit: show preview for active layer
      setTimeout(()=>showLayerPreviewTransform(), 60);
    }
  });
});

// ----------------- Filters (apply to active layer) -----------------
function applyFilterToActiveLayer(type) {
  saveState();
  const layer = layers[activeLayerIndex];
  let imgData = layer.ctx.getImageData(0,0,layer.canvas.width,layer.canvas.height);
  const data = imgData.data;
  if(type === 'invert'){
    for(let i=0;i<data.length;i+=4){
      data[i]=255-data[i]; data[i+1]=255-data[i+1]; data[i+2]=255-data[i+2];
    }
  } else if(type === 'bw'){
    for(let i=0;i<data.length;i+=4){
      const v = Math.round(0.299*data[i] + 0.587*data[i+1] + 0.114*data[i+2]);
      data[i]=data[i+1]=data[i+2]=v;
    }
  } else if(type === 'blur' || type === 'sharpen'){
    // small convolution kernel
    const kernel = type === 'blur' ? 
      [1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9] :
      [0,-1,0,-1,5,-1,0,-1,0]; // sharpen
    imgData = convolve(imgData, layer.canvas.width, layer.canvas.height, kernel);
  }
  layer.ctx.putImageData(imgData,0,0);
  renderComposite();
}

function convolve(imgData, width, height, kernel){
  const side = Math.round(Math.sqrt(kernel.length));
  const half = Math.floor(side/2);
  const src = imgData.data;
  const out = new Uint8ClampedArray(src.length);
  for(let y=0;y<height;y++){
    for(let x=0;x<width;x++){
      let r=0,g=0,b=0,a=0;
      for(let ky=0;ky<side;ky++){
        for(let kx=0;kx<side;kx++){
          const ix = x + kx - half;
          const iy = y + ky - half;
          if(ix>=0 && iy>=0 && ix<width && iy<height){
            const idx = (iy*width + ix)*4;
            const kval = kernel[ky*side + kx];
            r += src[idx] * kval;
            g += src[idx+1] * kval;
            b += src[idx+2] * kval;
            a += src[idx+3] * kval;
          }
        }
      }
      const outIdx = (y*width + x)*4;
      out[outIdx] = clamp(Math.round(r),0,255);
      out[outIdx+1] = clamp(Math.round(g),0,255);
      out[outIdx+2] = clamp(Math.round(b),0,255);
      out[outIdx+3] = clamp(Math.round(a),0,255) || src[outIdx+3];
    }
  }
  const newImg = new ImageData(out, width, height);
  return newImg;
}
function clamp(v,min,max){return Math.max(min,Math.min(max,v));}

document.getElementById('filter-invert').addEventListener('click', ()=> applyFilterToActiveLayer('invert'));
document.getElementById('filter-bw').addEventListener('click', ()=> applyFilterToActiveLayer('bw'));
document.getElementById('filter-blur').addEventListener('click', ()=> applyFilterToActiveLayer('blur'));
document.getElementById('filter-sharpen').addEventListener('click', ()=> applyFilterToActiveLayer('sharpen'));

// ----------------- Selection tool -----------------
const selectionPreview = document.getElementById('selection-preview');
const selectionPreviewImg = document.getElementById('selection-preview-img');
let selStart = null, selRect = null, isSelecting = false;
let selectionImage = null; // offscreen image (canvas) of selection
let selectionTransform = {posX:0,posY:0,scale:1,rotation:0,dragging:false,offsetX:0,offsetY:0};

function startSelection(clientX, clientY){
  if(currentTool !== 'select') {
    // switch tool to select if not already
    currentTool = 'select';
    setToolHighlight('select');
  }
  const containerRect = document.getElementById('app-container').getBoundingClientRect();
  selStart = {x: clientX - containerRect.left, y: clientY - containerRect.top};
  isSelecting = true;
  // hide existing selection preview while dragging marquee
  selectionPreview.style.display = 'none';
  selectionRectDraw();
  const onMove = (ev) => {
    if(!isSelecting) return;
    const moveX = (ev.touches ? ev.touches[0].clientX : ev.clientX) - containerRect.left;
    const moveY = (ev.touches ? ev.touches[0].clientY : ev.clientY) - containerRect.top;
    selRect = {x: Math.min(selStart.x, moveX), y: Math.min(selStart.y, moveY), w: Math.abs(moveX - selStart.x), h: Math.abs(moveY - selStart.y)};
    selectionRectDraw();
  };
  const onUp = (ev) => {
    if(isSelecting){
      isSelecting = false;
      if(selRect && selRect.w>0 && selRect.h>0){
        // capture selection from active layer
        finalizeSelection();
      }
    }
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onUp);
    document.removeEventListener('touchmove', onMove);
    document.removeEventListener('touchend', onUp);
  };
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onUp);
  document.addEventListener('touchmove', onMove, {passive:false});
  document.addEventListener('touchend', onUp);
}

function selectionRectDraw(){
  if(!selRect){ return; }
  // show ephemeral dashed rect on main canvas via composite overlay (we'll use selectionPreview)
  selectionPreview.style.display = 'block';
  selectionPreview.style.left = selRect.x + 'px';
  selectionPreview.style.top = selRect.y + 'px';
  selectionPreview.style.width = selRect.w + 'px';
  selectionPreview.style.height = selRect.h + 'px';
  selectionPreview.style.transform = 'none';
  selectionPreview.style.border = '2px dashed #39ff14';
  selectionPreviewImg.src = '';
}

function finalizeSelection(){
  // read pixels from active layer for the selection rectangle and create an image element
  const layer = layers[activeLayerIndex];
  // convert selRect from container coordinates to layer canvas coords
  const container = document.getElementById('app-container');
  const scaleX = layer.canvas.width / container.offsetWidth;
  const scaleY = layer.canvas.height / container.offsetHeight;
  const sx = Math.round(selRect.x * scaleX);
  const sy = Math.round(selRect.y * scaleY);
  const sw = Math.max(1, Math.round(selRect.w * scaleX));
  const sh = Math.max(1, Math.round(selRect.h * scaleY));
  // create offscreen canvas for selection
  const off = document.createElement('canvas');
  off.width = sw;
  off.height = sh;
  const offCtx = off.getContext('2d');
  offCtx.imageSmoothingEnabled = false;
  offCtx.clearRect(0,0,sw,sh);
  offCtx.drawImage(layer.canvas, sx, sy, sw, sh, 0, 0, sw, sh);
  // clear the area from the layer (so moving selection looks like cut/move)
  saveState();
  layer.ctx.clearRect(sx, sy, sw, sh);
  renderComposite();
  // show selection preview overlay (image) that is transformable (scale & rotate)
  const dataUrl = off.toDataURL();
  selectionPreviewImg.src = dataUrl;
  selectionPreview.style.left = selRect.x + 'px';
  selectionPreview.style.top = selRect.y + 'px';
  selectionPreview.style.width = selRect.w + 'px';
  selectionPreview.style.height = selRect.h + 'px';
  selectionPreview.style.display = 'block';
  selectionTransform.posX = selRect.x;
  selectionTransform.posY = selRect.y;
  selectionTransform.scale = 1;
  selectionTransform.rotation = 0;
  selectionImage = off;
  // make the preview draggable
  selectionPreview.onmousedown = (e) => {
    selectionTransform.dragging = true;
    const rect = selectionPreview.getBoundingClientRect();
    selectionTransform.offsetX = e.clientX - rect.left;
    selectionTransform.offsetY = e.clientY - rect.top;
    selectionPreview.style.cursor = 'grabbing';
  };
  document.addEventListener('mousemove', selectionMove);
  document.addEventListener('mouseup', selectionUp);
  // touch support
  selectionPreview.ontouchstart = (e) => {
    if(e.touches.length!==1) return;
    selectionTransform.dragging = true;
    const rect = selectionPreview.getBoundingClientRect();
    const t = e.touches[0];
    selectionTransform.offsetX = t.clientX - rect.left;
    selectionTransform.offsetY = t.clientY - rect.top;
    selectionPreview.style.cursor = 'grabbing';
  };
  document.addEventListener('touchmove', selectionMove, {passive:false});
  document.addEventListener('touchend', selectionUp);
  // simple keyboard shortcuts: [ and ] rotate
  window.addEventListener('keydown', selectionKeyHandler);
}

function selectionMove(e){
  if(!selectionTransform.dragging) return;
  const containerRect = document.getElementById('app-container').getBoundingClientRect();
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  const posX = clientX - containerRect.left - selectionTransform.offsetX;
  const posY = clientY - containerRect.top - selectionTransform.offsetY;
  selectionTransform.posX = posX;
  selectionTransform.posY = posY;
  updateSelectionTransform();
  if(e.cancelable) e.preventDefault();
}
function selectionUp(){
  selectionTransform.dragging = false;
  if(selectionPreview) selectionPreview.style.cursor = 'grab';
}
function selectionKeyHandler(e){
  if(!selectionImage) return;
  if(e.key === '['){ selectionTransform.rotation -= 5; updateSelectionTransform(); }
  if(e.key === ']'){ selectionTransform.rotation += 5; updateSelectionTransform(); }
  if(e.key === '-' || e.key === '_'){ selectionTransform.scale = Math.max(0.1, selectionTransform.scale - 0.05); updateSelectionTransform(); }
  if(e.key === '+' || e.key === '='){ selectionTransform.scale = Math.min(5, selectionTransform.scale + 0.05); updateSelectionTransform(); }
}

function updateSelectionTransform(){
  selectionPreview.style.left = selectionTransform.posX + 'px';
  selectionPreview.style.top = selectionTransform.posY + 'px';
  const w = Number(selectionPreview.style.width.replace('px','')) || selectionImage.width;
  const h = Number(selectionPreview.style.height.replace('px','')) || selectionImage.height;
  selectionPreview.style.transform = `rotate(${selectionTransform.rotation}deg) scale(${selectionTransform.scale})`;
}

// commit (stamp) selection back to active layer at current transform
function commitSelectionToActiveLayer(){
  if(!selectionImage) return;
  const layer = layers[activeLayerIndex];
  const container = document.getElementById('app-container');
  // compute target position in layer pixels
  const posX = selectionTransform.posX;
  const posY = selectionTransform.posY;
  const sw = selectionImage.width;
  const sh = selectionImage.height;
  const targetW = (Number(selectionPreview.style.width.replace('px','')) || selRect.w) * selectionTransform.scale;
  const targetH = (Number(selectionPreview.style.height.replace('px','')) || selRect.h) * selectionTransform.scale;
  const px = Math.round(posX * (layer.canvas.width / container.offsetWidth));
  const py = Math.round(posY * (layer.canvas.height / container.offsetHeight));
  const tW = Math.round(targetW * (layer.canvas.width / container.offsetWidth));
  const tH = Math.round(targetH * (layer.canvas.height / container.offsetHeight));
  // draw onto layer with rotation and scale
  saveState();
  const tcanvas = document.createElement('canvas');
  tcanvas.width = layer.canvas.width;
  tcanvas.height = layer.canvas.height;
  const tctx = tcanvas.getContext('2d');
  tctx.imageSmoothingEnabled = false;
  tctx.drawImage(layer.canvas, 0, 0); // start with current layer (which had selection area cleared earlier)
  tctx.save();
  // transform origin at center of target placement
  tctx.translate(px + tW/2, py + tH/2);
  tctx.rotate(selectionTransform.rotation * Math.PI / 180);
  tctx.drawImage(selectionImage, -tW/2, -tH/2, tW, tH);
  tctx.restore();
  // replace layer with new content
  layer.ctx.clearRect(0,0,layer.canvas.width,layer.canvas.height);
  layer.ctx.drawImage(tcanvas, 0, 0);
  // cleanup selection UI
  clearSelection();
  renderComposite();
}

function clearSelection(){
  selectionPreview.style.display = 'none';
  selectionPreviewImg.src = '';
  selectionImage = null;
  selStart = selRect = null;
  selectionTransform = {posX:0,posY:0,scale:1,rotation:0,dragging:false,offsetX:0,offsetY:0};
  document.removeEventListener('mousemove', selectionMove);
  document.removeEventListener('mouseup', selectionUp);
  document.removeEventListener('touchmove', selectionMove);
  document.removeEventListener('touchend', selectionUp);
  window.removeEventListener('keydown', selectionKeyHandler);
}

document.getElementById('select-cancel').addEventListener('click', function(){
  // restore selection area by doing nothing (we cleared the layer area on selection finalize, so we need to restore from undo)
  // easiest approach: undo last action (which was saved when selection was finalized), but only if undo stack has something
  if(undoStack.length>0){
    undo();
  } else {
    clearSelection();
    renderComposite();
  }
});
document.getElementById('select-commit').addEventListener('click', function(){ commitSelectionToActiveLayer(); });

// ----------------- Layer initialization UI update -----------------
updateLayerUI();

// Ensure layer preview hides when import canceled
importCancelBtn.addEventListener('click', ()=> { hideImportPreview(); importResetState(); });

// Ensure preview removed when leaving edit dropdown explicitly
document.getElementById('edit-dropdown').addEventListener('click', ()=>{ /* keep open handling */ });

// Attach layer preview on open of edit (already handled above when clicking menu-title)

// Wire filter buttons style (neon green inline strokes already in CSS)
document.getElementById('filter-invert').addEventListener('click', ()=>{/* handled earlier */});
document.getElementById('filter-bw').addEventListener('click', ()=>{/* handled earlier */});
document.getElementById('filter-blur').addEventListener('click', ()=>{/* handled earlier */});
document.getElementById('filter-sharpen').addEventListener('click', ()=>{/* handled earlier */});

// Resize behavior: update canvases when container size changes
function resizeCanvas(){
  resizeCanvasAndLayers();
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// Keep some existing UI behavior intact for tool switching
document.querySelectorAll('.tool-option').forEach(opt=>{
  opt.addEventListener('click', ()=>{
    // existing handling already wired above
  });
});

// Final notes:
// - Many operations (import, selection, layer transforms) create temporary DOM image elements that are used to present a transform UI, and when committed they stamp back onto the active layer.
// - Undo snapshots capture whole-layer ImageData which allows restoring cleared selection areas when user cancels selection (undo used).
// - Eraser uses destination-out for true transparency erasing on layers.
// - Filters (blur/sharpen) use a simple convolution; heavy images may be slow but work for typical canvas sizes.

</script>
<div class="footer"><center><a href="https://instagram.com/poiz.0ne">@poiz.0ne</a></center></div>
</body>
</html>
